<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine H√≥a h·ªçc AI v3.0 - Nh√† H√≥a h·ªçc AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS cho m√†u s·∫Øc d·ªÖ qu·∫£n l√Ω */
        :root {
            --dark-bg: #111827;
            --light-bg: #1f2937;
            --panel-bg: #374151;
            --accent-color: #8b5cf6; /* M√†u t√≠m l√†m ƒëi·ªÉm nh·∫•n */
            --danger-color: #ef4444; /* M√†u ƒë·ªè cho l·ªói */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #e5e7eb; /* M√†u ch·ªØ s√°ng */
            padding: 1rem; /* Padding t·ªïng th·ªÉ */
        }
        .simulation-container {
            width: 95vw;
            max-width: 1000px;
            background: var(--light-bg);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column; /* S·∫Øp x·∫øp c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc */
            gap: 1rem; /* Kho·∫£ng c√°ch gi·ªØa c√°c ph·∫ßn t·ª≠ */
        }
        #reaction-chamber {
            position: relative;
            width: 100%;
            height: 500px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho bu·ªìng ph·∫£n ·ª©ng */
            background: var(--dark-bg);
            border-radius: 1rem;
            overflow: hidden; /* ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng tr√†n ra ngo√†i */
            cursor: grab; /* Con tr·ªè k√©o */
            display: flex; /* D√πng flexbox ƒë·ªÉ cƒÉn gi·ªØa n·ªôi dung l·ªói WebGL */
            justify-content: center;
            align-items: center;
        }
        #reaction-chamber canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .ui-panel {
            background: var(--panel-bg);
            border-radius: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        #equation-input {
            flex-grow: 1; /* Cho ph√©p input m·ªü r·ªông */
            background: var(--light-bg);
            border: 1px solid var(--accent-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #fff;
            outline: none; /* B·ªè vi·ªÅn outline m·∫∑c ƒë·ªãnh */
            transition: border-color 0.3s; /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u vi·ªÅn */
        }
        #equation-input:focus {
            border-color: #a78bfa; /* M√†u vi·ªÅn khi focus */
        }
        .main-btn {
            background-image: linear-gradient(to right, #6366f1, var(--accent-color));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease; /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† */
            font-weight: 600;
            display: flex; /* D√πng flexbox ƒë·ªÉ cƒÉn gi·ªØa spinner v√† text */
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .main-btn:hover {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            transform: translateY(-2px); /* Hi·ªáu ·ª©ng nh·∫•c nh·∫π */
        }
        .main-btn:disabled {
            background-image: none;
            background-color: #4b5563;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #controls-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .icon-btn {
            background: transparent;
            border: 1px solid #6b7280;
            color: #d1d5db;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        .icon-btn:hover {
            border-color: var(--accent-color);
            color: white;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }
        .icon-btn:disabled {
            color: #6b7280;
            border-color: #4b5563;
            cursor: not-allowed;
            box-shadow: none;
        }

        #progress-container {
            flex-grow: 1;
            height: 8px;
            background: #4b5563;
            border-radius: 99px;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: var(--accent-color);
            border-radius: 99px;
            transition: width 0.3s ease; /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông cho thanh ti·∫øn tr√¨nh */
        }
        #info-text {
            text-align: center;
            min-height: 24px; /* Gi·ªØ ch·ªó ƒë·ªÉ tr√°nh nh·∫£y layout */
            color: #e5e7eb;
        }

        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Th√¥ng b√°o l·ªói WebGL */
        .webgl-error-message {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--danger-color); /* N·ªÅn ƒë·ªè cho l·ªói */
            color: white;
            border-radius: 0.75rem;
            font-size: 1rem;
            max-width: 80%;
        }
        .webgl-error-message h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .webgl-error-message p {
            margin-bottom: 0.5rem;
        }
        .webgl-error-message a {
            color: #fee2e2;
            text-decoration: underline;
        }
        .webgl-error-message a:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="simulation-container">
        <h1 class="text-2xl font-bold text-center mb-4">Nh√† H√≥a h·ªçc AI v3.0</h1>
        <div id="reaction-chamber">
            <!-- Th√¥ng b√°o l·ªói WebGL s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y n·∫øu c·∫ßn -->
        </div>
        <div class="ui-panel">
            <div class="input-group">
                <input id="equation-input" type="text" value="Hydro v√† Oxy" placeholder="Nh·∫≠p c√°c ch·∫•t tham gia (vd: S·∫Øt v√† Oxi)...">
                <button id="generate-btn" class="main-btn">
                    T·∫°o Ph·∫£n ·ª©ng
                    <div id="loading-spinner" class="spinner hidden"></div>
                </button>
            </div>
             <div id="controls-bar">
                <button id="play-pause-btn" class="icon-btn" disabled>‚ñ∂Ô∏è</button>
                <button id="restart-btn" class="icon-btn" disabled>üîÑ</button>
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>
            </div>
            <p id="info-text">H√£y xem AI d·ª± ƒëo√°n v√† di·ªÖn h·ªça ph·∫£n ·ª©ng h√≥a h·ªçc!</p>
        </div>
    </div>

    <!-- Imports -->
    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // --- Firebase, AI, 3D Engine Setup ---
        const firebaseConfig = { apiKey: "AIzaSyBVpguEIjTnIVOk1Ld0u-BGC7nM-pSww_o", authDomain: "aihoa-ac63b.firebaseapp.com", projectId: "aihoa-ac63b", storageBucket: "aihoa-ac63b.firebasestorage.app", messagingSenderId: "241068548961", appId: "1:241068548961:web:33d4126d020e9372d15b20"};
        let model;
        try {
            const app = initializeApp(firebaseConfig);
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            // S·ª≠ d·ª•ng gemini-2.5-flash ƒë·ªÉ t·∫°o n·ªôi dung
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o Firebase/AI:", e);
            // Hi·ªÉn th·ªã l·ªói n·∫øu kh√¥ng th·ªÉ kh·ªüi t·∫°o AI
            document.getElementById('info-text').innerText = "L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI Engine. Vui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.";
            document.getElementById('generate-btn').disabled = true;
        }

        const chamber = document.getElementById('reaction-chamber');
        let renderer, scene, camera, controls, composer, mainTimeline;
        let molecules = [];

        function init3D() {
            // X√≥a n·ªôi dung l·ªói WebGL c≈© n·∫øu c√≥
            chamber.innerHTML = '';
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, chamber.clientWidth / chamber.clientHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(chamber.clientWidth, chamber.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                chamber.appendChild(renderer.domElement);

                // C√†i ƒë·∫∑t Post-processing (Bloom effect)
                const renderPass = new RenderPass(scene, camera);
                const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                bloomPass.threshold = 0;
                bloomPass.strength = 1.2;
                bloomPass.radius = 0.5;
                const outputPass = new OutputPass();

                composer = new EffectComposer(renderer);
                composer.addPass(renderPass);
                composer.addPass(bloomPass);
                composer.addPass(outputPass);

                // Th√™m ƒë√®n
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                directionalLight.position.set(5, 10, 7.5);
                scene.add(directionalLight);

                camera.position.z = 15; // ƒê·∫∑t v·ªã tr√≠ ban ƒë·∫ßu c·ªßa camera

                // ƒêi·ªÅu khi·ªÉn OrbitControls cho ph√©p xoay, ph√≥ng to/thu nh·ªè khung c·∫£nh
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true; // Cho ph√©p hi·ªáu ·ª©ng "ƒë·ªô tr·ªÖ" khi xoay

                // V√≤ng l·∫∑p ho·∫°t ·∫£nh ch√≠nh
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update(); // C·∫≠p nh·∫≠t ƒëi·ªÅu khi·ªÉn
                    composer.render(); // Render scene v·ªõi post-processing
                }
                animate();

                // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï
                window.addEventListener('resize', () => {
                    camera.aspect = chamber.clientWidth / chamber.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(chamber.clientWidth, chamber.clientHeight);
                    composer.setSize(chamber.clientWidth, chamber.clientHeight);
                });

            } catch (error) {
                console.error("L·ªói kh·ªüi t·∫°o WebGL:", error);
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói th√¢n thi·ªán h∆°n
                chamber.innerHTML = `
                    <div class="webgl-error-message">
                        <h2>L·ªói WebGL</h2>
                        <p>Tr√¨nh duy·ªát c·ªßa b·∫°n c√≥ th·ªÉ kh√¥ng h·ªó tr·ª£ ho·∫∑c WebGL ƒëang b·ªã t·∫Øt.</p>
                        <p>ƒê·ªÉ tr·∫£i nghi·ªám ho·∫°t ·∫£nh 3D, vui l√≤ng ƒë·∫£m b·∫£o tr√¨nh duy·ªát c·ªßa b·∫°n ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√† WebGL ƒë∆∞·ª£c b·∫≠t.</p>
                        <p><a href="https://get.webgl.org/" target="_blank">Ki·ªÉm tra tr·∫°ng th√°i WebGL c·ªßa b·∫°n t·∫°i ƒë√¢y</a></p>
                    </div>
                `;
                // V√¥ hi·ªáu h√≥a n√∫t t·∫°o ph·∫£n ·ª©ng n·∫øu 3D kh√¥ng th·ªÉ kh·ªüi t·∫°o
                generateBtn.disabled = true;
                throw new Error("WebGL init failed");
            }
        }

        // --- Core Application Logic ---
        const generateBtn = document.getElementById('generate-btn');
        const input = document.getElementById('equation-input');
        const infoText = document.getElementById('info-text');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressBar = document.getElementById('progress-bar');
        const loadingSpinner = document.getElementById('loading-spinner'); // Spinner m·ªõi

        function clearScene() {
            // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c ph√¢n t·ª≠ kh·ªèi scene v√† gi·∫£i ph√≥ng b·ªô nh·ªõ
            molecules.forEach(m => {
                m.children.forEach(c => {
                    if (c.geometry) c.geometry.dispose();
                    if (c.material) c.material.dispose();
                });
                scene.remove(m);
            });
            molecules = [];
        }

        // H√†m v·∫Ω ph√¢n t·ª≠ 3D
        function drawMolecule3D(moleculeDef, x, y, z) {
            const group = new THREE.Group();
            const atomRadius = 0.5; // B√°n k√≠nh nguy√™n t·ª≠

            moleculeDef.atoms.forEach((atomDef, i) => {
                const geometry = new THREE.SphereGeometry(atomRadius, 32, 32);
                // T·∫°o v·∫≠t li·ªáu v·ªõi hi·ªáu ·ª©ng kim lo·∫°i v√† ƒë·ªô nh√°m
                const material = new THREE.MeshStandardMaterial({
                    color: atomDef.color,
                    metalness: 0.4,
                    roughness: 0.4,
                    emissive: '#000000' // Kh√¥ng ph√°t s√°ng ban ƒë·∫ßu
                });
                const atomMesh = new THREE.Mesh(geometry, material);

                // S·∫Øp x·∫øp c√°c nguy√™n t·ª≠ trong ph√¢n t·ª≠ (ƒë∆°n gi·∫£n h√≥a)
                if (moleculeDef.atoms.length > 1) {
                    const angle = (i / moleculeDef.atoms.length) * 2 * Math.PI;
                    atomMesh.position.x = Math.cos(angle) * atomRadius * 1.5; // M·ªü r·ªông kho·∫£ng c√°ch m·ªôt ch√∫t
                    atomMesh.position.y = Math.sin(angle) * atomRadius * 1.5;
                }
                group.add(atomMesh);
            });

            group.position.set(x, y, z); // ƒê·∫∑t v·ªã tr√≠ nh√≥m ph√¢n t·ª≠
            scene.add(group); // Th√™m v√†o scene
            molecules.push(group); // L∆∞u tr·ªØ ƒë·ªÉ qu·∫£n l√Ω
            return group;
        }

        // --- Animation Engine ---
        function runAnimation(plan) {
            // D·ª´ng v√† x√≥a timeline c≈© n·∫øu c√≥
            if (mainTimeline) mainTimeline.kill();
            clearScene(); // X√≥a c√°c ph√¢n t·ª≠ c≈©

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ ph·∫£n ·ª©ng tr√™n UI
            infoText.innerText = `ƒêang chu·∫©n b·ªã ho·∫°t ·∫£nh cho: ${plan.title}`;

            // Kh·ªüi t·∫°o GSAP Timeline
            mainTimeline = gsap.timeline({
                onUpdate: () => {
                    progressBar.style.width = `${mainTimeline.progress() * 100}%`;
                    playPauseBtn.textContent = mainTimeline.paused() ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
                },
                onComplete: () => {
                    infoText.innerText = "Ho·∫°t ·∫£nh ho√†n t·∫•t!";
                    playPauseBtn.textContent = "‚ñ∂Ô∏è";
                    playPauseBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t play/pause khi ho√†n th√†nh
                }
            });

            // K√≠ch ho·∫°t c√°c n√∫t ƒëi·ªÅu khi·ªÉn
            playPauseBtn.disabled = false;
            restartBtn.disabled = false;
            playPauseBtn.textContent = "‚è∏Ô∏è"; // ƒê·∫∑t th√†nh pause ban ƒë·∫ßu

            const reactantObjects = [];
            let reactantX = -10; // V·ªã tr√≠ X ban ƒë·∫ßu cho ch·∫•t ph·∫£n ·ª©ng

            // V·∫Ω c√°c ch·∫•t ph·∫£n ·ª©ng
            plan.reactants.forEach((r) => {
                for (let j = 0; j < r.count; j++) {
                    const moleculeObj = drawMolecule3D(r, reactantX, (j % 2 === 0 ? 1 : -1) * 4, 0);
                    reactantObjects.push({ obj: moleculeObj });
                    reactantX += 5; // Di chuy·ªÉn v·ªã tr√≠ X cho ph√¢n t·ª≠ ti·∫øp theo
                }
            });

            // Th√™m c√°c b∆∞·ªõc ho·∫°t ·∫£nh v√†o timeline
            plan.animationSteps.forEach(step => {
                // Th√™m m·ªôt label v√† m·ªôt callback ƒë·ªÉ c·∫≠p nh·∫≠t text t·∫°i c√πng m·ªôt th·ªùi ƒëi·ªÉm
                mainTimeline.add(() => { infoText.innerText = step.text || '...'; }, step.type);

                if (step.type === 'move_to_center') {
                    // Di chuy·ªÉn camera v√† c√°c ph√¢n t·ª≠ v√†o trung t√¢m
                    mainTimeline.to(camera.position, { z: 25, duration: 2.5, ease: "power2.inOut"}, step.type);
                    reactantObjects.forEach((m, i) => {
                        mainTimeline.to(m.obj.position, { x: (i % 3 - 1) * 3, y: Math.floor(i / 3) * 3 - 1, z: 0, duration: 2.5, ease: "power2.inOut" }, step.type);
                    });
                } else if (step.type === 'break_bonds') {
                    // Ph√° v·ª° li√™n k·∫øt, c√°c nguy√™n t·ª≠ t√°ch ra v√† ph√°t s√°ng
                    mainTimeline.to(camera.position, { z: 12, duration: 2, ease: "power2.inOut"}, step.type);
                    reactantObjects.forEach(m => {
                        m.obj.children.forEach((atomMesh, i) => {
                            mainTimeline.to(atomMesh.material.emissive, { r: 1, g: 1, b: 0.8, duration: 1, ease: "power2.in" }, step.type);
                            const angle = (i / m.obj.children.length) * 2 * Math.PI;
                            mainTimeline.to(atomMesh.position, { x: atomMesh.position.x + Math.cos(angle) * 0.8, y: atomMesh.position.y + Math.sin(angle) * 0.8, duration: 2, ease: "back.out(4)" }, step.type);
                        });
                    });
                } else if (step.type === 'rearrange') {
                    // S·∫Øp x·∫øp l·∫°i, c√°c ph√¢n t·ª≠ c≈© bi·∫øn m·∫•t, s·∫£n ph·∫©m m·ªõi xu·∫•t hi·ªán
                    reactantObjects.forEach(m => {
                        mainTimeline.to(m.obj.children.map(c => c.material), { opacity: 0, duration: 1, onComplete: () => scene.remove(m.obj) }, step.type);
                    });

                    // Hi·ªáu ·ª©ng t·ªèa nhi·ªát n·∫øu l√† ph·∫£n ·ª©ng t·ªèa nhi·ªát
                    if (plan.isExothermic) {
                        mainTimeline.add(() => {
                            const shockwaveGeo = new THREE.TorusGeometry(1, 0.1, 16, 100);
                            const shockwaveMat = new THREE.MeshBasicMaterial({ color: 0xffffee, transparent: true, opacity: 1 });
                            const shockwave = new THREE.Mesh(shockwaveGeo, shockwaveMat);
                            shockwave.rotation.x = Math.PI / 2;
                            scene.add(shockwave);
                            gsap.to(shockwave.scale, { x: 20, y: 20, z: 20, duration: 2, ease: "power1.out" });
                            gsap.to(shockwave.material, { opacity: 0, duration: 2, ease: "power1.out", onComplete: () => scene.remove(shockwave) });
                        }, step.type + "+=0.5"); // Hi·ªáu ·ª©ng xu·∫•t hi·ªán sau m·ªôt ch√∫t

                    }

                    let productX = -5; // V·ªã tr√≠ X ban ƒë·∫ßu cho s·∫£n ph·∫©m
                    // V·∫Ω c√°c s·∫£n ph·∫©m m·ªõi
                    plan.products.forEach(p => {
                        for (let j = 0; j < p.count; j++) {
                            const productObj = drawMolecule3D(p, productX, (j % 2 === 0 ? 1 : -1) * 3, 0);
                            productObj.children.forEach(c => { c.material.transparent = true; c.material.opacity = 0; }); // Ban ƒë·∫ßu ·∫©n s·∫£n ph·∫©m
                            mainTimeline.to(productObj.children.map(c => c.material), { opacity: 1, duration: 2 }, step.type + "+=1"); // Hi·ªáu ·ª©ng xu·∫•t hi·ªán
                            mainTimeline.to(productObj.children.map(c => c.material.emissive), { r: 0, g: 0, b: 0, duration: 2 }, step.type + "+=1"); // T·∫Øt ph√°t s√°ng
                            productX += 5;
                        }
                    });
                }
            });
        }

        async function generateReactionPlan() {
            // Ki·ªÉm tra tr·∫°ng th√°i AI engine v√† renderer
            if (!model || !renderer) {
                infoText.innerText = "L·ªói: Engine AI ho·∫∑c m√¥i tr∆∞·ªùng 3D ch∆∞a s·∫µn s√†ng.";
                return;
            }
            const userInput = input.value;
            if (!userInput) {
                infoText.innerText = "Vui l√≤ng nh·∫≠p c√°c ch·∫•t tham gia.";
                return;
            }

            infoText.innerHTML = 'AI ƒëang t∆∞ duy... üß†';
            generateBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t
            loadingSpinner.classList.remove('hidden'); // Hi·ªÉn th·ªã spinner

            // Prompt m·ªõi cho AI
            const prompt = `
            T·ª´ c√°c ch·∫•t tham gia do ng∆∞·ªùi d√πng cung c·∫•p l√†: "${userInput}".
            H√£y th·ª±c hi·ªán c√°c b∆∞·ªõc sau m·ªôt c√°ch tu·∫ßn t·ª±:
            1. D·ª± ƒëo√°n s·∫£n ph·∫©m h√≥a h·ªçc c√≥ kh·∫£ nƒÉng x·∫£y ra nh·∫•t trong ƒëi·ªÅu ki·ªán ti√™u chu·∫©n.
            2. Vi·∫øt ph∆∞∆°ng tr√¨nh h√≥a h·ªçc ƒë·∫ßy ƒë·ªß v√† ƒë√£ ƒë∆∞·ª£c c√¢n b·∫±ng cho ph·∫£n ·ª©ng ƒë√≥.
            3. D·ª±a tr√™n ph∆∞∆°ng tr√¨nh b·∫°n v·ª´a t·∫°o, h√£y t·∫°o m·ªôt k·ªãch b·∫£n ho·∫°t ·∫£nh chi ti·∫øt d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.

            ƒê·ªëi t∆∞·ª£ng JSON ph·∫£i c√≥ c·∫•u tr√∫c ch√≠nh x√°c nh∆∞ sau:
            - "title": (string) Ph∆∞∆°ng tr√¨nh h√≥a h·ªçc ƒë·∫ßy ƒë·ªß m√† b·∫°n ƒë√£ t·∫°o (v√≠ d·ª•: "2H2 + O2 -> 2H2O").
            - "isExothermic": (boolean) Ph·∫£n ·ª©ng c√≥ t·ªèa nhi·ªát hay kh√¥ng (true n·∫øu t·ªèa nhi·ªát, false n·∫øu thu nhi·ªát ho·∫∑c kh√¥ng x√°c ƒë·ªãnh).
            - "reactants": (array) M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng ch·∫•t ph·∫£n ·ª©ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ d·∫°ng {molecule: string, count: number, atoms: [{symbol: string, color: string}]}.
            - "products": (array) M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng s·∫£n ph·∫©m, c·∫•u tr√∫c t∆∞∆°ng t·ª± reactants.
            - "animationSteps": (array) M·ªôt m·∫£ng c√°c b∆∞·ªõc ho·∫°t ·∫£nh, m·ªói b∆∞·ªõc c√≥ d·∫°ng {type: 'move_to_center' | 'break_bonds' | 'rearrange', text: string}.
                - 'move_to_center': C√°c ph√¢n t·ª≠ di chuy·ªÉn v√†o trung t√¢m bu·ªìng ph·∫£n ·ª©ng.
                - 'break_bonds': Li√™n k·∫øt gi·ªØa c√°c nguy√™n t·ª≠ b·ªã ph√° v·ª°, c√°c nguy√™n t·ª≠ t√°ch r·ªùi.
                - 'rearrange': C√°c nguy√™n t·ª≠ t·ª± s·∫Øp x·∫øp l·∫°i ƒë·ªÉ t·∫°o th√†nh s·∫£n ph·∫©m m·ªõi.

            S·ª≠ d·ª•ng c√°c m√†u sau cho nguy√™n t·ª≠ (h√£y t·ª± suy ra c√°c m√†u kh√°c n·∫øu c·∫ßn):
            - H: #FFFFFF (Tr·∫Øng)
            - O: #FF6B6B (ƒê·ªè)
            - C: #333333 (X√°m ƒëen)
            - N: #6B9AFF (Xanh d∆∞∆°ng)
            - Fe: #A19D94 (X√°m kim lo·∫°i)
            - S: #FFF36B (V√†ng)
            - Cl: #6BFF8B (Xanh l√°)
            - Na: #B06BFF (T√≠m)
            - K: #8A2BE2 (T√≠m nh·∫°t)
            - Mg: #BDB76B (V√†ng xanh)
            - Ca: #DDA0DD (T√≠m hoa c√†)
            - Al: #C0C0C0 (B·∫°c)
            - P: #FFA500 (Cam)
            - Br: #A52A2A (N√¢u)
            - I: #4B0082 (Ch√†m)

            Quan tr·ªçng: Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt kh·ªëi m√£ JSON h·ª£p l·ªá duy nh·∫•t, kh√¥ng ch·ª©a "'''json" hay b·∫•t k·ª≥ vƒÉn b·∫£n gi·∫£i th√≠ch n√†o kh√°c.
            `;

            try {
                // G·ªçi API Gemini
                const result = await model.generateContent(prompt);
                const textResponse = result.response.text();

                // D·ªçn d·∫πp vƒÉn b·∫£n ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ l√† JSON h·ª£p l·ªá
                const cleanedText = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                const plan = JSON.parse(cleanedText); // Ph√¢n t√≠ch JSON

                runAnimation(plan); // Ch·∫°y ho·∫°t ·∫£nh d·ª±a tr√™n k·∫ø ho·∫°ch
            } catch (error) {
                console.error("L·ªói ph√¢n t√≠ch ho·∫∑c t·∫°o ho·∫°t ·∫£nh:", error);
                infoText.innerText = "ƒê√£ c√≥ l·ªói x·∫£y ra. AI c√≥ th·ªÉ ƒë√£ tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng ƒë√∫ng ho·∫∑c g·∫∑p l·ªói. Vui l√≤ng th·ª≠ l·∫°i.";
            } finally {
                generateBtn.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t
                loadingSpinner.classList.add('hidden'); // ·∫®n spinner
            }
        }

        // --- Event Listeners cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn m·ªõi ---
        playPauseBtn.addEventListener('click', () => {
            if (mainTimeline) {
                mainTimeline.paused(!mainTimeline.paused()); // ƒê·∫£o ng∆∞·ª£c tr·∫°ng th√°i t·∫°m d·ª´ng
            }
        });

        restartBtn.addEventListener('click', () => {
            if (mainTimeline) {
                mainTimeline.restart(); // Kh·ªüi ƒë·ªông l·∫°i ho·∫°t ·∫£nh
            }
        });

        // Kh·ªüi t·∫°o m√¥i tr∆∞·ªùng 3D khi trang t·∫£i xong
        init3D();
        // L·∫Øng nghe s·ª± ki·ªán click n√∫t "T·∫°o Ph·∫£n ·ª©ng"
        generateBtn.addEventListener('click', generateReactionPlan);
    </script>
</body>
</html>

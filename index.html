<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Tuần Hoàn Tương Tác - AI hoạt động</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            font-size: 10px; /* Base font size for easy rem calculations */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 1.5rem;
        }
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto 1rem auto;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        .search-container {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-container input {
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 1.4rem;
        }
        .temperature-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .temperature-controls label {
            font-weight: 700;
            font-size: 1.6rem;
            color: #0056b3;
        }
        .temperature-controls button {
            background-color: #e0f2fe;
            border: 1px solid #007bff;
            color: #007bff;
            font-weight: bold;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1.8rem;
        }
        .temperature-controls button:hover {
            background-color: #cce9ff;
        }
        .temperature-controls input {
            width: 7rem;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 0.5rem;
            font-size: 1.5rem;
            font-weight: 500;
        }
        .container {
            max-width: 1400px;
            width: 100%;
            margin: auto;
        }
        
        .status-message {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            font-weight: 500;
            color: #555;
            height: 2rem;
            transition: color 0.3s ease;
        }
        .status-message.error-text { color: #dc3545; }
        .status-message.success-text { color: #28a745; }
        .status-message.info-text { color: #0056b3; }


        .legend-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.8rem;
            max-width: 1200px;
            margin: 0 auto 2rem auto;
        }
        .legend-item {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.2rem;
            font-weight: 500;
            border: 1px solid transparent;
        }
        .legend-item:hover {
            opacity: 0.8;
        }
        .legend-item.selected {
            border: 1px solid #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            transform: translateY(-2px);
        }

        .periodic-table-wrapper {
            display: grid;
            grid-template-columns: 2.5rem repeat(18, 1fr);
            gap: 4px;
        }
        .period-number {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 700;
            color: #555;
        }
        .periodic-table-grid {
            grid-column: 2 / span 18;
            display: grid;
            grid-template-columns: repeat(18, minmax(0, 1fr));
            gap: 4px;
        }

        .element-cell {
            border-radius: 4px;
            padding: 0.5rem 0.2rem;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.2s ease-in-out, opacity 0.3s ease, filter 0.3s ease;
            font-size: 1rem;
            line-height: 1.1;
            min-height: 60px;
            position: relative;
            text-align: center;
            color: #333;
        }
        .element-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .element-cell.dimmed {
            opacity: 0.2;
            filter: grayscale(80%);
            pointer-events: none;
        }
        .element-number {
            font-size: 1.1rem;
            font-weight: 500;
            position: absolute;
            top: 4px;
            left: 4px;
        }
        .element-symbol {
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 0.2rem;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .element-name, .element-mass {
            font-size: 1rem;
            margin-top: 0.1rem;
        }

        /* Symbol colors for physical state */
        .state-solid { color: #000000; }
        .state-liquid { color: #008000; }
        .state-gas { color: #ff0000; }
        .state-unknown { color: #888888; }

        /* Background colors for element groups */
        .alkali-metal { background-color: #ffcdd2; border: 1px solid #e57373; }
        .alkaline-earth-metal { background-color: #ffe0b2; border: 1px solid #ffb74d; }
        .transition-metal { background-color: #e1f5fe; border: 1px solid #4fc3f7; }
        .post-transition-metal { background-color: #b2dfdb; border: 1px solid #4db6ac; }
        .metalloid { background-color: #cfd8dc; border: 1px solid #90a4ae; }
        .other-nonmetal { background-color: #f0f4c3; border: 1px solid #dce775; }
        .halogen { background-color: #d1c4e9; border: 1px solid #9575cd; }
        .noble-gas { background-color: #b3e5fc; border: 1px solid #4dd0e1; }
        .lanthanide { background-color: #fff9c4; border: 1px solid #fff176; }
        .actinide { background-color: #ffccbc; border: 1px solid #ff8a65; }
        
        .empty-cell { visibility: hidden; pointer-events: none; }
        .lanthanide-ref, .actinide-ref {
            background-color: #d1eaff;
            border: 1px solid #a6d4fa;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        /* Bottom F-Block */
        .f-block-wrapper { margin: 2rem auto; max-width: 1060px; }
        .f-block-grid { display: grid; grid-template-columns: 2.5rem 2.7rem 1fr; gap: 4px; align-items: center; }
        .f-block-table { display: grid; grid-template-columns: repeat(15, 1fr); gap: 4px; }
    
        /* Bottom Sheet */
        #bottomSheetOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; }
        #bottomSheet { position: fixed; bottom: 0; left: 0; width: 100%; max-height: 80vh; background-color: #ffffff; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -8px 20px rgba(0,0,0,0.2); z-index: 1001; transform: translateY(100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; }
        #bottomSheet.active { transform: translateY(0); }
        #bottomSheetContent { padding: 25px; overflow-y: auto; flex-grow: 1; }
        #bottomSheet .close-button { position: sticky; top: 0; align-self: flex-end; margin: 15px 15px 0 0; background: #e0e0e0; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 1002; }
        #bottomSheet .close-button:hover { background-color: #d0d0d0; }
        #bottomSheetContent h3 { font-size: 2.2rem; font-weight: 700; color: #007bff; margin-bottom: 15px; }
        
        .loading-spinner { display: flex; justify-content: center; align-items: center; min-height: 100px; }
        .spinner { border: 4px solid rgba(0, 123, 255, 0.3); border-left-color: #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="top-controls">
        <div class="search-container">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search text-gray-400" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
            <input type="text" id="searchInput" placeholder="Tìm kiếm nguyên tố...">
        </div>
        <div class="temperature-controls">
            <label>Nhiệt độ:</label>
            <button id="tempMinusBtn">-</button>
            <input type="number" id="kelvinInput" value="298">
            <label>K</label>
            <button id="tempPlusBtn">+</button>
        </div>
    </div>
    
    <div id="statusMessage" class="status-message"></div>
    <div id="legend-container" class="legend-container"></div>

    <div class="container">
        <div class="periodic-table-wrapper" id="periodicTableWrapper"></div>
        <div class="f-block-wrapper">
            <div class="f-block-grid" id="lanthanidesBlock"></div>
            <div class="f-block-grid mt-2" id="actinidesBlock"></div>
        </div>
    </div>
    
    <div id="bottomSheetOverlay"></div>
    <div id="bottomSheet">
        <button class="close-button" id="closeBottomSheet">X</button>
        <div id="bottomSheetContent">
            <h3 id="detailElementName">Chọn một nguyên tố</h3>
            <div id="geminiDetailContent"></div>
            <div id="geminiLoading" class="loading-spinner hidden">
                <div class="spinner"></div>
                <p class="ml-4 text-blue-600">Đang hỏi Gemini AI...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBsTFay_kTVzr2J50pxrAUdiuOBkwNSJHY",
            authDomain: "aith-c70eb.firebaseapp.com",
            projectId: "aith-c70eb",
            storageBucket: "aith-c70eb.firebasestorage.app",
            messagingSenderId: "556224999133",
            appId: "1:556224999133:web:a79ae0f22b612dc167b534"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, model;
        let elements = [];
        let currentTemperatureKelvin = 298;
        let activeGroupFilter = null;

        const dom = {
            tableWrapper: document.getElementById('periodicTableWrapper'),
            lanthanidesBlock: document.getElementById('lanthanidesBlock'),
            actinidesBlock: document.getElementById('actinidesBlock'),
            searchInput: document.getElementById('searchInput'),
            kelvinInput: document.getElementById('kelvinInput'),
            tempMinusBtn: document.getElementById('tempMinusBtn'),
            tempPlusBtn: document.getElementById('tempPlusBtn'),
            legendContainer: document.getElementById('legend-container'),
            bottomSheet: document.getElementById('bottomSheet'),
            bottomSheetOverlay: document.getElementById('bottomSheetOverlay'),
            closeBottomSheetButton: document.getElementById('closeBottomSheet'),
            detailElementName: document.getElementById('detailElementName'),
            geminiDetailContent: document.getElementById('geminiDetailContent'),
            geminiLoading: document.getElementById('geminiLoading'),
            statusMessage: document.getElementById('statusMessage'),
        };
        
        const atomicMasses = { 1:1.008,2:4.0026,3:6.94,4:9.0122,5:10.81,6:12.011,7:14.007,8:15.999,9:18.998,10:20.18,11:22.99,12:24.305,13:26.982,14:28.085,15:30.974,16:32.06,17:35.45,18:39.948,19:39.098,20:40.078,21:44.956,22:47.867,23:50.942,24:51.996,25:54.938,26:55.845,27:58.933,28:58.693,29:63.546,30:65.38,31:69.723,32:72.63,33:74.922,34:78.971,35:79.904,36:83.798,37:85.468,38:87.62,39:88.906,40:91.224,41:92.906,42:95.96,43:98,44:101.07,45:102.91,46:106.42,47:107.87,48:112.41,49:114.82,50:118.71,51:121.76,52:127.6,53:126.9,54:131.29,55:132.91,56:137.33,57:138.91,58:140.12,59:140.91,60:144.24,61:145,62:150.36,63:151.96,64:157.25,65:158.93,66:162.5,67:164.93,68:167.26,69:168.93,70:173.05,71:174.97,72:178.49,73:180.95,74:183.84,75:186.21,76:190.23,77:192.22,78:195.08,79:196.97,80:200.59,81:204.38,82:207.2,83:208.98,84:209,85:210,86:222,87:223,88:226,89:227,90:232.04,91:231.04,92:238.03,93:237,94:244,95:243,96:247,97:247,98:251,99:252,100:257,101:258,102:259,103:266,104:267,105:268,106:269,107:270,108:269,109:278,110:281,111:282,112:285,113:286,114:289,115:289,116:293,117:294,118:294 };
        function augmentElementData(elements) {
            return elements.map(el => ({ ...el, atomic_mass: atomicMasses[el.number] || 0 }));
        }

        function updateStatus(type, message) {
            dom.statusMessage.className = `status-message ${type}`;
            dom.statusMessage.textContent = message;
        }

        function createCell(element) {
            const cell = document.createElement('div');
            cell.className = `element-cell ${element.group}`;
            cell.dataset.symbol = element.symbol;
            cell.dataset.name = element.name;
            cell.dataset.number = element.number;
            cell.dataset.group = element.group;
            cell.innerHTML = `<span class="element-number">${element.number}</span><div class="element-symbol">${element.symbol}</div><div class="element-name">${element.name}</div><div class="element-mass">${element.atomic_mass > 0 ? element.atomic_mass.toFixed(3) : ''}</div>`;
            cell.addEventListener('click', () => handleElementClick(element));
            return cell;
        }
        
        function getPhysicalState(temperatureK, meltingPointC, boilingPointC) {
            if (meltingPointC === null) return 'unknown';
            const meltingK = meltingPointC + 273.15;
            const boilingK = boilingPointC + 273.15;
            if (temperatureK < meltingK) return 'solid';
            if (temperatureK >= meltingK && temperatureK < boilingK) return 'liquid';
            if (temperatureK >= boilingK) return 'gas';
            return 'unknown';
        }

        function updateElementStates() {
            dom.kelvinInput.value = Math.round(currentTemperatureKelvin);
            elements.forEach(element => {
                const cell = document.querySelector(`.element-cell[data-number='${element.number}']`);
                if (!cell) return;
                const symbolDiv = cell.querySelector('.element-symbol');
                const state = getPhysicalState(currentTemperatureKelvin, element.melting_point_celsius, element.boiling_point_celsius);
                symbolDiv.classList.remove('state-solid', 'state-liquid', 'state-gas', 'state-unknown');
                symbolDiv.classList.add(`state-${state}`);
            });
        }

        function applyGroupFilter() {
            document.querySelectorAll('.element-cell').forEach(cell => {
                cell.classList.toggle('dimmed', activeGroupFilter && cell.dataset.group !== activeGroupFilter);
            });
        }
        
        function handleSearch() {
            const query = dom.searchInput.value.toLowerCase().trim();
            if(activeGroupFilter) {
                activeGroupFilter = null;
                document.querySelector('.legend-item.selected')?.classList.remove('selected');
                applyGroupFilter();
            }
            document.querySelectorAll('.element-cell').forEach(cell => {
                if (!query) {
                    cell.classList.remove('dimmed');
                    return;
                }
                const name = cell.dataset.name.toLowerCase();
                const symbol = cell.dataset.symbol.toLowerCase();
                const number = cell.dataset.number;
                cell.classList.toggle('dimmed', !(name.includes(query) || symbol.startsWith(query) || number === query));
            });
        }
        
        function createTopLegend() {
            const legendData = [
                { class: 'alkali-metal', text: 'Kim loại kiềm' }, { class: 'alkaline-earth-metal', text: 'Kim loại kiềm thổ' },
                { class: 'transition-metal', text: 'Kim loại chuyển tiếp' }, { class: 'post-transition-metal', text: 'Kim loại sau CT' },
                { class: 'lanthanide', text: 'Họ Lantan' }, { class: 'actinide', text: 'Họ Actini' }, { class: 'metalloid', text: 'Á kim' },
                { class: 'other-nonmetal', text: 'Phi kim khác' }, { class: 'halogen', text: 'Halogen' }, { class: 'noble-gas', text: 'Khí hiếm' },
            ];
            dom.legendContainer.innerHTML = '';
            legendData.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = `legend-item ${item.class}`;
                legendItem.textContent = item.text;
                legendItem.dataset.group = item.class;
                dom.legendContainer.appendChild(legendItem);
            });
        }

        function handleLegendClick(event) {
            const clickedItem = event.target.closest('.legend-item');
            if (!clickedItem) return;
            dom.searchInput.value = '';
            handleSearch();
            const group = clickedItem.dataset.group;
            if (activeGroupFilter === group) {
                activeGroupFilter = null;
                clickedItem.classList.remove('selected');
            } else {
                document.querySelector('.legend-item.selected')?.classList.remove('selected');
                activeGroupFilter = group;
                clickedItem.classList.add('selected');
            }
            applyGroupFilter();
        }

        function createUIGrids() {
            dom.tableWrapper.innerHTML = '';
            const grid = Array(7).fill(null).map(() => Array(18).fill(null));
            elements.forEach(el => {
                if (el.row > 7 || el.col > 18) return;
                if (el.group === 'lanthanide') {
                    if (!grid[5][2]) grid[5][2] = { type: 'ref', class: 'lanthanide-ref', text: '57-71' };
                    return;
                }
                if (el.group === 'actinide') {
                    if (!grid[6][2]) grid[6][2] = { type: 'ref', class: 'actinide-ref', text: '89-103' };
                    return;
                }
                grid[el.row - 1][el.col - 1] = { type: 'element', data: el };
            });

            for (let r = 0; r < 7; r++) {
                const periodNum = document.createElement('div');
                periodNum.className = 'period-number';
                periodNum.textContent = r + 1;
                dom.tableWrapper.appendChild(periodNum);
                const rowGrid = document.createElement('div');
                rowGrid.className = 'periodic-table-grid';
                rowGrid.style.gridRow = r + 1;
                for (let c = 0; c < 18; c++) {
                    const cellData = grid[r][c];
                    if (cellData) {
                        if (cellData.type === 'element') {
                             rowGrid.appendChild(createCell(cellData.data));
                        } else {
                             const refCell = document.createElement('div');
                             refCell.className = `element-cell ${cellData.class}`;
                             refCell.textContent = cellData.text;
                             rowGrid.appendChild(refCell);
                        }
                    } else {
                       const emptyCell = document.createElement('div');
                       emptyCell.className = 'empty-cell';
                       rowGrid.appendChild(emptyCell);
                    }
                }
                dom.tableWrapper.appendChild(rowGrid);
            }
            // Create F-Block
            dom.lanthanidesBlock.innerHTML = `<div class="period-number">6</div> <div></div> <div class="f-block-table" id="lanthanides-inner-grid"></div>`;
            dom.actinidesBlock.innerHTML = `<div class="period-number">7</div> <div></div> <div class="f-block-table" id="actinides-inner-grid"></div>`;
            const lanthGrid = document.getElementById('lanthanides-inner-grid');
            const actiGrid = document.getElementById('actinides-inner-grid');
            elements.filter(el => el.group === 'lanthanide').sort((a,b) => a.number - b.number).forEach(el => lanthGrid.appendChild(createCell(el)));
            elements.filter(el => el.group === 'actinide').sort((a,b) => a.number - b.number).forEach(el => actiGrid.appendChild(createCell(el)));
        }

        async function handleElementClick(element) {
            dom.bottomSheet.classList.add('active');
            dom.bottomSheetOverlay.style.display = 'block';
            dom.detailElementName.textContent = `${element.name} (${element.symbol})`;
            dom.geminiDetailContent.innerHTML = '';
            dom.geminiLoading.classList.remove('hidden');

            if (!model) {
                 dom.geminiDetailContent.innerHTML = `<p class="text-red-500 mt-4">Lỗi: Mô hình AI chưa được khởi tạo. Vui lòng đợi thông báo "AI đã sẵn sàng" hoặc kiểm tra lại.</p>`;
                 dom.geminiLoading.classList.add('hidden');
                 return;
            }

            try {
                const promptText = `Cung cấp thông tin chi tiết về nguyên tố hóa học ${element.name} (ký hiệu ${element.symbol}, số nguyên tử ${element.number}). Vui lòng bao gồm:\n- Cấu hình electron\n- Độ âm điện\n- Trạng thái ở điều kiện tiêu chuẩn\n- Điểm nóng chảy và điểm sôi (Celsius)\n- Lịch sử phát hiện (ngắn gọn)\n- Ứng dụng phổ biến (dạng danh sách)\nVui lòng trả lời dưới dạng văn bản có cấu trúc với các mục rõ ràng sử dụng định dạng Markdown. Sử dụng ngôn ngữ tiếng Việt.`;
                updateStatus('info-text', `Đang hỏi Gemini về ${element.name}...`);
                const result = await model.generateContent(promptText);
                const text = result.response.text();

                const finalHTML = `<p><strong>Số nguyên tử:</strong> ${element.number}</p><p><strong>Ký hiệu:</strong> ${element.symbol}</p><p><strong>Khối lượng nguyên tử:</strong> ${element.atomic_mass.toFixed(3)}</p><hr class="my-4 border-t border-blue-200"><div class="text-gray-800 text-base">${marked.parse(text)}</div>`;
                dom.geminiDetailContent.innerHTML = finalHTML;
                updateStatus('success-text', `Đã nhận thông tin về ${element.name}.`);
            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                const errorHTML = `<p><strong>Số nguyên tử:</strong> ${element.number}</p><p><strong>Ký hiệu:</strong> ${element.symbol}</p><p><strong>Khối lượng nguyên tử:</strong> ${element.atomic_mass.toFixed(3)}</p><hr class="my-4 border-t border-red-200"><p class="text-red-500 mt-4"><strong>Lỗi khi lấy thông tin từ Gemini AI:</strong><br>${error.message}</p>`;
                dom.geminiDetailContent.innerHTML = errorHTML;
                updateStatus('error-text', `Lỗi Gemini API.`);
            } finally {
                dom.geminiLoading.classList.add('hidden');
                setTimeout(() => updateStatus('success-text', 'AI Model đã sẵn sàng. Hãy chọn một nguyên tố!'), 4000);
            }
        }
        
        async function initializeFirebaseAndAI() {
            try {
                updateStatus('info-text', 'Đang khởi tạo Firebase & AI...');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                let authSuccess = false;
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        authSuccess = true;
                        console.log("Đăng nhập bằng custom token thành công.");
                    } catch (tokenError) {
                        console.error("Lỗi custom token (sẽ thử đăng nhập ẩn danh):", tokenError);
                        // Fallback to anonymous sign-in
                    }
                }

                if (!authSuccess) {
                    try {
                       await signInAnonymously(auth);
                       authSuccess = true;
                       console.log("Đăng nhập ẩn danh thành công.");
                    } catch (anonymousError) {
                        console.error("Lỗi đăng nhập ẩn danh:", anonymousError);
                        throw anonymousError; // Throw error to be caught by the outer catch
                    }
                }
                
                const ai = getAI(app, { backend: new GoogleAIBackend() });
                model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
                console.log("Generative Model instance đã tạo!");
                updateStatus('success-text', 'AI Model đã sẵn sàng. Hãy chọn một nguyên tố!');
            } catch(e) {
                console.error("Lỗi cuối cùng khi khởi tạo AI:", e);
                updateStatus('error-text', `Lỗi khởi tạo AI. Chức năng AI sẽ không hoạt động.`);
            }
        }

        async function main() {
            try {
                updateStatus('info-text', 'Đang tải dữ liệu bảng tuần hoàn...');
                const response = await fetch('https://minhvtv4.github.io/aihoa/elements.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const rawElements = await response.json();
                elements = augmentElementData(rawElements);
                createTopLegend();
                createUIGrids();
                updateElementStates();
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu ban đầu:", error);
                document.body.innerHTML = `<p class="text-red-500 text-center mt-10">Không thể tải dữ liệu bảng tuần hoàn. Vui lòng thử lại.</p>`;
                updateStatus('error-text', 'Tải dữ liệu thất bại.');
                return;
            }
            
            // Setup Listeners
            dom.searchInput.addEventListener('input', handleSearch);
            dom.legendContainer.addEventListener('click', handleLegendClick);
            dom.tempMinusBtn.addEventListener('click', () => { currentTemperatureKelvin = Math.max(0, currentTemperatureKelvin - 10); updateElementStates(); });
            dom.tempPlusBtn.addEventListener('click', () => { currentTemperatureKelvin += 10; updateElementStates(); });
            dom.kelvinInput.addEventListener('change', () => { currentTemperatureKelvin = parseFloat(dom.kelvinInput.value) || 298; updateElementStates(); });
            dom.closeBottomSheetButton.addEventListener('click', () => { dom.bottomSheet.classList.remove('active'); dom.bottomSheetOverlay.style.display = 'none'; });
            dom.bottomSheetOverlay.addEventListener('click', () => dom.closeBottomSheetButton.click());

            // Initialize the backend after UI is ready
            await initializeFirebaseAndAI();
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

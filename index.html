<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Tuần Hoàn Tương Tác với Gemini AI</title>
    <!-- Tailwind CSS CDN để tạo kiểu nhanh chóng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN để chuyển đổi Markdown sang HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Responsive font-size and base dimensions inspired by Ptable */
        :root {
            /* Base font-size scales with viewport width for general elements */
            font-size: calc(0.8rem + 0.4vw);
        }
        @media (min-width: 1200px) {
            /* Adjust for larger screens to prevent font-size from becoming too large */
            :root {
                font-size: calc(1rem + 0.2vw);
            }
        }
        @media (max-width: 768px) {
            /* Adjust for smaller screens */
            :root {
                font-size: calc(0.7rem + 0.5vw);
            }
        }
        @media (max-width: 480px) {
            /* Even smaller screens (mobile) */
            :root {
                font-size: calc(0.6rem + 0.8vw);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
        }
        .periodic-table-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(0, 1fr)); /* 18 cột cho bảng tuần hoàn */
            gap: 4px; /* Khoảng cách giữa các ô */
            background-color: #fff;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        /* Grid riêng cho khối f-block, cũng 18 cột để giữ bố cục */
        .lanthanides-grid, .actinides-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(0, 1fr));
            gap: 4px;
            background-color: #fff;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-top: 10px;
        }

        .element-cell {
            background-color: #e0f2fe; /* Màu nền mặc định cho ô nguyên tố */
            border: 1px solid #a7d9ff;
            border-radius: 8px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out, opacity 0.3s ease, filter 0.3s ease; /* Thêm transition cho opacity và filter */
            font-size: 0.75em; /* Sử dụng 'em' để kế thừa từ root font-size */
            line-height: 1;
            min-height: 50px;
            position: relative;
            text-align: center;
        }
        .element-cell:hover {
            background-color: #cce9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .element-cell.active {
            background-color: #007bff;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            z-index: 10;
        }
        /* Style for dimmed elements when a filter is active */
        .element-cell.dimmed {
            opacity: 0.2;
            filter: grayscale(80%);
            pointer-events: none; /* Disable interaction when dimmed */
        }
        /* Override dimmed for active elements */
        .element-cell.active:not(.dimmed) {
            opacity: 1;
            filter: none;
            pointer-events: auto;
        }
        .element-number {
            font-size: 0.6em; /* Sử dụng 'em' */
            align-self: flex-start;
            position: absolute;
            top: 4px;
            left: 4px;
            font-weight: 500;
            color: rgba(0,0,0,0.6);
        }
        .element-symbol {
            font-size: 1.2em; /* Sử dụng 'em' */
            font-weight: 700;
            margin-top: 8px;
            color: #1a202c;
        }
        .element-name {
            font-size: 0.65em; /* Sử dụng 'em' */
            margin-top: 2px;
            text-align: center;
            color: #4a5568;
        }

        /* Styling cho các nhóm nguyên tố */
        .alkali-metal { background-color: #ffcdd2; }
        .alkaline-earth-metal { background-color: #ffe0b2; }
        .transition-metal { background-color: #e3f2fd; }
        .post-transition-metal { background-color: #b2dfdb; }
        .metalloid { background-color: #cfd8dc; }
        .other-nonmetal { background-color: #f0f4c3; }
        .halogen { background-color: #d1c4e9; }
        .noble-gas { background-color: #b3e5fc; }
        .lanthanide { background-color: #fff9c4; }
        .actinide { background-color: #ffccbc; }
        .lanthanide-placeholder, .actinide-placeholder {
            background-color: #ddd;
            color: #555;
            font-weight: bold;
        }

        /* Màu sắc cho trạng thái vật lý */
        .element-cell.Solid { background-color: #d8e2dc; color: #2a5a54; } /* Màu xanh lá cây xám */
        .element-cell.Liquid { background-color: #cce9ff; color: #007bff; } /* Màu xanh dương nhạt hơn */
        .element-cell.Gas { background-color: #ffcccb; color: #dc3545; } /* Màu đỏ nhạt hơn */
        .element-cell.UnknownState { background-color: #e0e0e0; color: #777; } /* Màu xám */

        /* Placeholder rỗng để giữ đúng vị trí */
        .empty-cell {
            visibility: hidden;
            pointer-events: none;
        }

        /* Vùng hiển thị thông tin chi tiết (bottom sheet) */
        #bottomSheetOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        #bottomSheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 80vh;
            background-color: #ffffff;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        #bottomSheet.active {
            transform: translateY(0);
        }

        #bottomSheetContent {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        #bottomSheet .close-button {
            position: sticky;
            top: 0;
            align-self: flex-end;
            margin-right: 15px;
            margin-top: 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em; /* Sử dụng 'em' */
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 1002;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #bottomSheet .close-button:hover {
            background-color: #d0d0d0;
        }

        #bottomSheetContent h3 {
            font-size: 1.8em; /* Sử dụng 'em' */
            font-weight: 700;
            color: #007bff;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0f2fe;
            padding-bottom: 10px;
        }
        #bottomSheetContent p {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 1em; /* Sử dụng 'em' */
        }
        #bottomSheetContent strong {
            color: #0056b3;
        }

        /* Styling cho phản hồi từ AI (sử dụng Marked.js) */
        #bottomSheetContent h1, #bottomSheetContent h2, #bottomSheetContent h3, #bottomSheetContent h4, #bottomSheetContent h5, #bottomSheetContent h6 {
            color: #0056b3;
            font-weight: 600;
            margin-top: 1.5em; /* Sử dụng 'em' */
            margin-bottom: 0.5em; /* Sử dụng 'em' */
        }
        #bottomSheetContent h1 { font-size: 1.8em; }
        #bottomSheetContent h2 { font-size: 1.6em; }
        #bottomSheetContent h3 { font-size: 1.4em; }
        #bottomSheetContent h4 { font-size: 1.2em; }
        #bottomSheetContent h5 { font-size: 1.1em; }
        #bottomSheetContent h6 { font-size: 1em; }

        #bottomSheetContent ul {
            list-style: disc;
            margin-left: 20px;
            padding-left: 0;
            margin-bottom: 10px;
        }
        #bottomSheetContent ol {
            list-style: decimal;
            margin-left: 20px;
            padding-left: 0;
            margin-bottom: 10px;
        }
        #bottomSheetContent li {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        #bottomSheetContent strong {
            font-weight: 700;
        }
        #bottomSheetContent em {
            font-style: italic;
        }
        #bottomSheetContent code {
            background-color: #e6fffa;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em; /* Sử dụng 'em' */
            color: #008080;
        }
        #bottomSheetContent pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em; /* Sử dụng 'em' */
            line-height: 1.4;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #bottomSheetContent a {
            color: #007bff;
            text-decoration: underline;
        }
        #bottomSheetContent blockquote {
            border-left: 44px solid #ccc;
            padding-left: 15px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }

        /* Slider and associated controls */
        .slider-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-top: 20px;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
        }
        .slider-controls label {
            font-weight: 600;
            margin-right: 10px;
            color: #0056b3;
        }
        .slider-controls input[type="range"] {
            flex-grow: 1;
            margin: 0 15px;
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #4a75b3, #8cb3d9, #e0f2fe, #ffc9a8, #ff8c8c, #d94a4a); /* Gradient nhiệt độ */
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        .slider-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .temp-inputs {
            display: flex;
            gap: 10px;
            margin-left: 15px;
            flex-wrap: wrap;
        }
        .temp-inputs div {
            display: flex;
            align-items: center;
        }
        .temp-inputs input[type="number"] {
            width: 70px;
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: right;
            font-size: 0.9em;
        }
        .temp-inputs span {
            margin-left: 5px;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Legend sections integrated into the grid */
        .legend-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden; /* Prevent content overflow if too small */
        }

        .legend-section h3 {
            font-size: 1.2em;
            font-weight: 700;
            color: #0056b3;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0f2fe;
            width: 100%; /* Make border-bottom span full width */
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .legend-item {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.9em;
            font-weight: 500;
            border: 1px solid transparent; /* Default transparent border */
        }

        /* Specific colors for legend items (can reuse element group colors) */
        .legend-item[data-filter-value="Solid"] { background-color: #d8e2dc; color: #2a5a54; }
        .legend-item[data-filter-value="Liquid"] { background-color: #cce9ff; color: #007bff; }
        .legend-item[data-filter-value="Gas"] { background-color: #ffcccb; color: #dc3545; }
        .legend-item[data-filter-value="UnknownState"] { background-color: #e0e0e0; color: #777; }

        .legend-item[data-filter-value="alkali-metal"] { background-color: #ffcdd2; }
        .legend-item[data-filter-value="alkaline-earth-metal"] { background-color: #ffe0b2; }
        .legend-item[data-filter-value="transition-metal"] { background-color: #e3f2fd; }
        .legend-item[data-filter-value="post-transition-metal"] { background-color: #b2dfdb; }
        .legend-item[data-filter-value="metalloid"] { background-color: #cfd8dc; }
        .legend-item[data-filter-value="other-nonmetal"] { background-color: #f0f4c3; }
        .legend-item[data-filter-value="halogen"] { background-color: #d1c4e9; }
        .legend-item[data-filter-value="noble-gas"] { background-color: #b3e5fc; }
        .legend-item[data-filter-value="lanthanide"] { background-color: #fff9c4; }
        .legend-item[data-filter-value="actinide"] { background-color: #ffccbc; }


        .legend-item:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .legend-item.selected-filter-item {
            box-shadow: 0 0 0 3px #007bff; /* Highlight with a blue border/shadow */
            transform: translateY(-2px);
            font-weight: 700;
        }

        /* Reset Button */
        #resetButton {
            background-color: #607d8b; /* A neutral gray/blue */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 20px; /* Space from temperature controls */
        }
        #resetButton:hover {
            background-color: #455a64;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }
        .spinner {
            border: 4px solid rgba(0, 123, 255, 0.3);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            margin-top: 15px;
            font-weight: bold;
            font-size: 0.95em; /* Sử dụng 'em' */
            color: #555;
            text-align: center;
            width: 100%;
        }
        .status-message.error-text { color: #dc3545; }
        .status-message.success-text { color: #28a745; }
        .status-message.info-text { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>Bảng Tuần Hoàn Nguyên Tố Hóa Học Tương Tác</h1>
    <p class="status-message" id="statusMessage">Đang khởi tạo...</p>

    <div class="slider-controls">
        <label for="temperatureRange">Nhiệt độ:</label>
        <input type="range" id="temperatureRange" min="-273.15" max="6000" value="25" step="0.1">
        <div class="temp-inputs">
            <div>
                <input type="number" id="celsiusInput" value="25" step="0.1">
                <span>°C</span>
            </div>
            <div>
                <input type="number" id="fahrenheitInput" value="77" step="0.1">
                <span>°F</span>
            </div>
            <div>
                <input type="number" id="kelvinInput" value="298.15" step="0.1">
                <span>K</span>
            </div>
        </div>
        <button id="resetButton">Reset Bảng</button>
    </div>

    <div class="container">
        <div class="periodic-table-grid" id="periodicTable">
            <!-- Các ô nguyên tố chính và các mục chú giải sẽ được tạo bởi JavaScript -->
        </div>

        <!-- Khoảng cách giữa bảng chính và khối f-block -->
        <div class="my-6"></div>

        <!-- Khối Lanthanide riêng biệt -->
        <div class="periodic-table-grid lanthanides-grid" id="lanthanidesBlock">
            <!-- Lanthanides sẽ được tạo bởi JavaScript -->
        </div>

        <!-- Khối Actinide riêng biệt -->
        <div class="periodic-table-grid actinides-grid mt-4" id="actinidesBlock">
            <!-- Actinides sẽ được tạo bởi JavaScript -->
        </div>

        <!-- Bottom Sheet Overlay -->
        <div id="bottomSheetOverlay"></div>

        <!-- Bottom Sheet (hiển thị thông tin chi tiết nguyên tố) -->
        <div id="bottomSheet">
            <button class="close-button" id="closeBottomSheet">X</button>
            <div id="bottomSheetContent">
                <h3 id="detailElementName">Chọn một nguyên tố để xem chi tiết</h3>
                <div id="geminiDetailContent">
                    <p>Nhấp vào một nguyên tố trong bảng tuần hoàn để Gemini AI điền thông tin chi tiết.</p>
                </div>
                <div id="geminiLoading" class="loading-spinner hidden">
                    <div class="spinner"></div>
                    <p class="ml-4 text-blue-600">Đang hỏi Gemini AI...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import các hàm bạn cần từ SDK bạn cần
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";

        // Cấu hình Firebase của ứng dụng web của bạn (từ file gốc bạn cung cấp)
        const firebaseConfig = {
            apiKey: "AIzaSyBsTFay_kTVzr2J50pxrAUdiuOBkwNSJHY",
            authDomain: "aith-c70eb.firebaseapp.com",
            projectId: "aith-c70eb",
            storageBucket: "aith-c70eb.firebasestorage.app",
            messagingSenderId: "556224999133",
            appId: "1:556224999133:web:a79ae0f22b612dc167b534"
        };

        // Các biến toàn cục từ môi trường Canvas (nếu có, ưu tiên sử dụng)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth; // Biến cho Firebase Authentication
        let model;
        let userId = null; // ID người dùng (sẽ được lấy sau khi xác thực)

        // Lấy các phần tử DOM
        const periodicTable = document.getElementById('periodicTable');
        const lanthanidesBlock = document.getElementById('lanthanidesBlock');
        const actinidesBlock = document.getElementById('actinidesBlock');
        const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
        const bottomSheet = document.getElementById('bottomSheet');
        const closeBottomSheetButton = document.getElementById('closeBottomSheet');
        const detailElementName = document.getElementById('detailElementName');
        const geminiDetailContent = document.getElementById('geminiDetailContent');
        const geminiLoading = document.getElementById('geminiLoading');
        const statusMessageElement = document.getElementById('statusMessage');

        // Các phần tử điều khiển nhiệt độ
        const temperatureRange = document.getElementById('temperatureRange');
        const celsiusInput = document.getElementById('celsiusInput');
        const fahrenheitInput = document.getElementById('fahrenheitInput');
        const kelvinInput = document.getElementById('kelvinInput');
        const resetButton = document.getElementById('resetButton'); // Nút reset

        let currentTemperatureCelsius = parseFloat(celsiusInput.value); // Nhiệt độ hiện tại tính bằng Celsius
        let activeFilter = { type: null, value: null, element: null }; // Để theo dõi bộ lọc đang hoạt động

        // Hàm cập nhật trạng thái hiển thị trên giao diện
        function updateStatus(type, message) {
            statusMessageElement.className = `status-message ${type}`;
            statusMessageElement.innerHTML = message;
        }

        // Hàm để hiển thị bottom sheet
        function showBottomSheet() {
            bottomSheetOverlay.style.display = 'block';
            bottomSheet.classList.add('active');
        }

        // Hàm để ẩn bottom sheet
        function hideBottomSheet() {
            bottomSheet.classList.remove('active');
            bottomSheet.addEventListener('transitionend', function handler() {
                bottomSheetOverlay.style.display = 'none';
                bottomSheet.removeEventListener('transitionend', handler);
            });
        }

        // Gắn sự kiện cho nút đóng bottom sheet và overlay
        closeBottomSheetButton.addEventListener('click', hideBottomSheet);
        bottomSheetOverlay.addEventListener('click', hideBottomSheet);

        // Khởi tạo Firebase và đăng nhập người dùng (ưu tiên custom token, sau đó ẩn danh)
        async function initializeFirebase() {
            try {
                updateStatus('info-text', "Đang khởi tạo Firebase App...");
                app = initializeApp(firebaseConfig);
                auth = getAuth(app); 
                
                let authSuccess = false;

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                        console.log("Đã đăng nhập bằng custom token. User ID:", userId);
                        updateStatus('success-text', "Firebase App đã khởi tạo và người dùng đã đăng nhập.");
                        authSuccess = true;
                    } catch (tokenError) {
                        console.error("Lỗi đăng nhập bằng custom token:", tokenError);
                        updateStatus('error-text', `Lỗi đăng nhập bằng custom token: ${tokenError.message}.`);
                        console.log("Thử đăng nhập ẩn danh...");
                    }
                } 
                
                if (!authSuccess) { 
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        console.log("Đã đăng nhập ẩn danh. User ID:", userId);
                        updateStatus('success-text', "Firebase App đã khởi tạo và người dùng đã đăng nhập.");
                        authSuccess = true;
                    } catch (authError) {
                        if (authError.code === 'auth/admin-restricted-operation') {
                            console.error("Lỗi xác thực ẩn danh (auth/admin-restricted-operation):", authError);
                            updateStatus('error-text', `Lỗi: ${authError.message}.<br>Vui lòng kích hoạt 'Đăng nhập ẩn danh' trong cài đặt Firebase Authentication của dự án của bạn (Firebase Console > Authentication > Sign-in method > Anonymous).`);
                        } else {
                            console.error("Lỗi đăng nhập ẩn danh:", authError);
                            updateStatus('error-text', `Lỗi đăng nhập: ${authError.message}.`);
                        }
                        authSuccess = false; 
                    }
                }
                
                if (authSuccess) {
                    initializeAIModel(); 
                } else {
                    updateStatus('error-text', "Không thể xác thực người dùng. AI Model sẽ không được khởi tạo.");
                    console.error("Authentication failed. AI Model will not be initialized.");
                }

            } catch (error) {
                console.error("Lỗi khi khởi tạo Firebase hoặc đăng nhập (chung):", error);
                updateStatus('error-text', `Lỗi khởi tạo Firebase: ${error.message}.`);
            }
        }

        // Khởi tạo AI Model
        function initializeAIModel() {
            try {
                updateStatus('info-text', "Đang khởi tạo AI Model...");
                const ai = getAI(app, { backend: new GoogleAIBackend() });
                model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" }); 
                console.log("Generative Model instance đã tạo với model 'gemini-1.5-flash-latest'!");
                updateStatus('success-text', "AI Model đã sẵn sàng. Hãy chọn một nguyên tố!");
            } catch (e) {
                console.error("Lỗi khi khởi tạo AI Model:", e);
                updateStatus('error-text', `Lỗi khởi tạo AI Model: ${e.message}.<br>Hãy đảm bảo Gemini API đã được kích hoạt cho dự án của bạn trong Google Cloud Console.`);
            }
        }

        // Dữ liệu đầy đủ của 118 nguyên tố hóa học với điểm nóng chảy và điểm sôi
        const elements = [
            // Period 1 (row 1)
            { number: 1, symbol: "H", name: "Hydrogen", group: "other-nonmetal", row: 1, col: 1, melting_point_celsius: -259.16, boiling_point_celsius: -252.87 },
            { number: 2, symbol: "He", name: "Helium", group: "noble-gas", row: 1, col: 18, melting_point_celsius: -272.2, boiling_point_celsius: -268.93 },
            // Period 2 (row 2)
            { number: 3, symbol: "Li", name: "Lithium", group: "alkali-metal", row: 2, col: 1, melting_point_celsius: 180.5, boiling_point_celsius: 1342 },
            { number: 4, symbol: "Be", name: "Beryllium", group: "alkaline-earth-metal", row: 2, col: 2, melting_point_celsius: 1287, boiling_point_celsius: 2471 },
            { number: 5, symbol: "B", name: "Boron", group: "metalloid", row: 2, col: 13, melting_point_celsius: 2075, boiling_point_celsius: 3927 },
            { number: 6, symbol: "C", name: "Carbon", group: "other-nonmetal", row: 2, col: 14, melting_point_celsius: 3550, boiling_point_celsius: 4827 }, // Sublimes
            { number: 7, symbol: "N", name: "Nitrogen", group: "other-nonmetal", row: 2, col: 15, melting_point_celsius: -210.0, boiling_point_celsius: -195.8 },
            { number: 8, symbol: "O", name: "Oxygen", group: "other-nonmetal", row: 2, col: 16, melting_point_celsius: -218.79, boiling_point_celsius: -182.95 },
            { number: 9, symbol: "F", name: "Fluorine", group: "halogen", row: 2, col: 17, melting_point_celsius: -219.67, boiling_point_celsius: -188.12 },
            { number: 10, symbol: "Ne", name: "Neon", group: "noble-gas", row: 2, col: 18, melting_point_celsius: -248.59, boiling_point_celsius: -246.08 },
            // Period 3 (row 3)
            { number: 11, symbol: "Na", name: "Sodium", group: "alkali-metal", row: 3, col: 1, melting_point_celsius: 97.72, boiling_point_celsius: 883 },
            { number: 12, symbol: "Mg", name: "Magnesium", group: "alkaline-earth-metal", row: 3, col: 2, melting_point_celsius: 650, boiling_point_celsius: 1091 },
            { number: 13, symbol: "Al", name: "Aluminum", group: "post-transition-metal", row: 3, col: 13, melting_point_celsius: 660.32, boiling_point_celsius: 2519 },
            { number: 14, symbol: "Si", name: "Silicon", group: "metalloid", row: 3, col: 14, melting_point_celsius: 1414, boiling_point_celsius: 3265 },
            { number: 15, symbol: "P", name: "Phosphorus", group: "other-nonmetal", row: 3, col: 15, melting_point_celsius: 44.15, boiling_point_celsius: 280.5 }, // White Phosphorus
            { number: 16, symbol: "S", name: "Sulfur", group: "other-nonmetal", row: 3, col: 16, melting_point_celsius: 115.21, boiling_point_celsius: 444.6 },
            { number: 17, symbol: "Cl", name: "Chlorine", group: "halogen", row: 3, col: 17, melting_point_celsius: -101.5, boiling_point_celsius: -34.04 },
            { number: 18, symbol: "Ar", name: "Argon", group: "noble-gas", row: 3, col: 18, melting_point_celsius: -189.34, boiling_point_celsius: -185.84 },
            // Period 4 (row 4)
            { number: 19, symbol: "K", name: "Potassium", group: "alkali-metal", row: 4, col: 1, melting_point_celsius: 63.5, boiling_point_celsius: 759 },
            { number: 20, symbol: "Ca", name: "Calcium", group: "alkaline-earth-metal", row: 4, col: 2, melting_point_celsius: 842, boiling_point_celsius: 1484 },
            { number: 21, symbol: "Sc", name: "Scandium", group: "transition-metal", row: 4, col: 3, melting_point_celsius: 1541, boiling_point_celsius: 2836 },
            { number: 22, symbol: "Ti", name: "Titanium", group: "transition-metal", row: 4, col: 4, melting_point_celsius: 1668, boiling_point_celsius: 3287 },
            { number: 23, symbol: "V", name: "Vanadium", group: "transition-metal", row: 4, col: 5, melting_point_celsius: 1910, boiling_point_celsius: 3407 },
            { number: 24, symbol: "Cr", name: "Chromium", group: "transition-metal", row: 4, col: 6, melting_point_celsius: 1857, boiling_point_celsius: 2671 },
            { number: 25, symbol: "Mn", name: "Manganese", group: "transition-metal", row: 4, col: 7, melting_point_celsius: 1246, boiling_point_celsius: 2061 },
            { number: 26, symbol: "Fe", name: "Iron", group: "transition-metal", row: 4, col: 8, melting_point_celsius: 1538, boiling_point_celsius: 2862 },
            { number: 27, symbol: "Co", name: "Cobalt", group: "transition-metal", row: 4, col: 9, melting_point_celsius: 1495, boiling_point_celsius: 2927 },
            { number: 28, symbol: "Ni", name: "Nickel", group: "transition-metal", row: 4, col: 10, melting_point_celsius: 1455, boiling_point_celsius: 2913 },
            { number: 29, symbol: "Cu", name: "Copper", group: "transition-metal", row: 4, col: 11, melting_point_celsius: 1084.62, boiling_point_celsius: 2562 },
            { number: 30, symbol: "Zn", name: "Zinc", group: "transition-metal", row: 4, col: 12, melting_point_celsius: 419.53, boiling_point_celsius: 907 },
            { number: 31, symbol: "Ga", name: "Gallium", group: "post-transition-metal", row: 4, col: 13, melting_point_celsius: 29.76, boiling_point_celsius: 2204 },
            { number: 32, symbol: "Ge", name: "Germanium", group: "metalloid", row: 4, col: 14, melting_point_celsius: 938.25, boiling_point_celsius: 2833 },
            { number: 33, symbol: "As", name: "Arsenic", group: "metalloid", row: 4, col: 15, melting_point_celsius: 817, boiling_point_celsius: 614 }, // Sublimes
            { number: 34, symbol: "Se", name: "Selenium", group: "other-nonmetal", row: 4, col: 16, melting_point_celsius: 221, boiling_point_celsius: 685 },
            { number: 35, symbol: "Br", name: "Bromine", group: "halogen", row: 4, col: 17, melting_point_celsius: -7.2, boiling_point_celsius: 58.8 },
            { number: 36, symbol: "Kr", name: "Krypton", group: "noble-gas", row: 4, col: 18, melting_point_celsius: -157.36, boiling_point_celsius: -153.22 },
            // Period 5 (row 5)
            { number: 37, symbol: "Rb", name: "Rubidium", group: "alkali-metal", row: 5, col: 1, melting_point_celsius: 39.3, boiling_point_celsius: 688 },
            { number: 38, symbol: "Sr", name: "Strontium", group: "alkaline-earth-metal", row: 5, col: 2, melting_point_celsius: 777, boiling_point_celsius: 1382 },
            { number: 39, symbol: "Y", name: "Yttrium", group: "transition-metal", row: 5, col: 3, melting_point_celsius: 1526, boiling_point_celsius: 3338 },
            { number: 40, symbol: "Zr", name: "Zirconium", group: "transition-metal", row: 5, col: 4, melting_point_celsius: 1855, boiling_point_celsius: 4377 },
            { number: 41, symbol: "Nb", name: "Niobium", group: "transition-metal", row: 5, col: 5, melting_point_celsius: 2477, boiling_point_celsius: 4744 },
            { number: 42, symbol: "Mo", name: "Molybdenum", group: "transition-metal", row: 5, col: 6, melting_point_celsius: 2623, boiling_point_celsius: 4639 },
            { number: 43, symbol: "Tc", name: "Technetium", group: "transition-metal", row: 5, col: 7, melting_point_celsius: 2157, boiling_point_celsius: 4265 },
            { number: 44, symbol: "Ru", name: "Ruthenium", group: "transition-metal", row: 5, col: 8, melting_point_celsius: 2334, boiling_point_celsius: 4150 },
            { number: 45, symbol: "Rh", name: "Rhodium", group: "transition-metal", row: 5, col: 9, melting_point_celsius: 1964, boiling_point_celsius: 3695 },
            { number: 46, symbol: "Pd", name: "Palladium", group: "transition-metal", row: 5, col: 10, melting_point_celsius: 1554.8, boiling_point_celsius: 2963 },
            { number: 47, symbol: "Ag", name: "Silver", group: "transition-metal", row: 5, col: 11, melting_point_celsius: 961.78, boiling_point_celsius: 2162 },
            { number: 48, symbol: "Cd", name: "Cadmium", group: "transition-metal", row: 5, col: 12, melting_point_celsius: 321.07, boiling_point_celsius: 767 },
            { number: 49, symbol: "In", name: "Indium", group: "post-transition-metal", row: 5, col: 13, melting_point_celsius: 156.6, boiling_point_celsius: 2072 },
            { number: 50, symbol: "Sn", name: "Tin", group: "post-transition-metal", row: 5, col: 14, melting_point_celsius: 231.93, boiling_point_celsius: 2602 },
            { number: 51, symbol: "Sb", name: "Antimony", group: "metalloid", row: 5, col: 15, melting_point_celsius: 630.63, boiling_point_celsius: 1587 },
            { number: 52, symbol: "Te", name: "Tellurium", group: "metalloid", row: 5, col: 16, melting_point_celsius: 449.5, boiling_point_celsius: 988 },
            { number: 53, symbol: "I", name: "Iodine", group: "halogen", row: 5, col: 17, melting_point_celsius: 113.7, boiling_point_celsius: 184.3 },
            { number: 54, symbol: "Xe", name: "Xenon", group: "noble-gas", row: 5, col: 18, melting_point_celsius: -111.7, boiling_point_celsius: -108.099 },
            // Period 6 (row 6) - Main table elements
            { number: 55, symbol: "Cs", name: "Caesium", group: "alkali-metal", row: 6, col: 1, melting_point_celsius: 28.44, boiling_point_celsius: 671 },
            { number: 56, symbol: "Ba", name: "Barium", group: "alkaline-earth-metal", row: 6, col: 2, melting_point_celsius: 727, boiling_point_celsius: 1897 },
            // Placeholder cho Lanthanides trong bảng chính
            { number: 57, symbol: "57-71", name: "Lanthanides", group: "lanthanide-placeholder", row: 6, col: 3, isPlaceholder: true, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 72, symbol: "Hf", name: "Hafnium", group: "transition-metal", row: 6, col: 4, melting_point_celsius: 2233, boiling_point_celsius: 4603 },
            { number: 73, symbol: "Ta", name: "Tantalum", group: "transition-metal", row: 6, col: 5, melting_point_celsius: 3017, boiling_point_celsius: 5458 },
            { number: 74, symbol: "W", name: "Tungsten", group: "transition-metal", row: 6, col: 6, melting_point_celsius: 3422, boiling_point_celsius: 5930 },
            { number: 75, symbol: "Re", name: "Rhenium", group: "transition-metal", row: 6, col: 7, melting_point_celsius: 3186, boiling_point_celsius: 5596 },
            { number: 76, symbol: "Os", name: "Osmium", group: "transition-metal", row: 6, col: 8, melting_point_celsius: 3033, boiling_point_celsius: 5012 },
            { number: 77, symbol: "Ir", name: "Iridium", group: "transition-metal", row: 6, col: 9, melting_point_celsius: 2466, boiling_point_celsius: 4428 },
            { number: 78, symbol: "Pt", name: "Platinum", group: "transition-metal", row: 6, col: 10, melting_point_celsius: 1768.3, boiling_point_celsius: 3825 },
            { number: 79, symbol: "Au", name: "Gold", group: "transition-metal", row: 6, col: 11, melting_point_celsius: 1064.18, boiling_point_celsius: 2856 },
            { number: 80, symbol: "Hg", name: "Mercury", group: "transition-metal", row: 6, col: 12, melting_point_celsius: -38.83, boiling_point_celsius: 356.73 },
            { number: 81, symbol: "Tl", name: "Thallium", group: "post-transition-metal", row: 6, col: 13, melting_point_celsius: 304, boiling_point_celsius: 1473 },
            { number: 82, symbol: "Pb", name: "Lead", group: "post-transition-metal", row: 6, col: 14, melting_point_celsius: 327.46, boiling_point_celsius: 1749 },
            { number: 83, symbol: "Bi", name: "Bismuth", group: "post-transition-metal", row: 6, col: 15, melting_point_celsius: 271.4, boiling_point_celsius: 1564 },
            { number: 84, symbol: "Po", name: "Polonium", group: "metalloid", row: 6, col: 16, melting_point_celsius: 254, boiling_point_celsius: 962 },
            { number: 85, symbol: "At", name: "Astatine", group: "halogen", row: 6, col: 17, melting_point_celsius: 302, boiling_point_celsius: 337 }, // Estimated
            { number: 86, symbol: "Rn", name: "Radon", group: "noble-gas", row: 6, col: 18, melting_point_celsius: -71, boiling_point_celsius: -61.7 },
            // Period 7 (row 7) - Main table elements
            { number: 87, symbol: "Fr", name: "Francium", group: "alkali-metal", row: 7, col: 1, melting_point_celsius: 27, boiling_point_celsius: 677 }, // Estimated
            { number: 88, symbol: "Ra", name: "Radium", group: "alkaline-earth-metal", row: 7, col: 2, melting_point_celsius: 700, boiling_point_celsius: 1737 },
            // Placeholder cho Actinides trong bảng chính
            { number: 89, symbol: "89-103", name: "Actinides", group: "actinide-placeholder", row: 7, col: 3, isPlaceholder: true, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 104, symbol: "Rf", name: "Rutherfordium", group: "transition-metal", row: 7, col: 4, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 105, symbol: "Db", name: "Dubnium", group: "transition-metal", row: 7, col: 5, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 106, symbol: "Sg", name: "Seaborgium", group: "transition-metal", row: 7, col: 6, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 107, symbol: "Bh", name: "Bohrium", group: "transition-metal", row: 7, col: 7, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 108, symbol: "Hs", name: "Hassium", group: "transition-metal", row: 7, col: 8, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 109, symbol: "Mt", name: "Meitnerium", group: "transition-metal", row: 7, col: 9, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 110, symbol: "Ds", name: "Darmstadtium", group: "transition-metal", row: 7, col: 10, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 111, symbol: "Rg", name: "Roentgenium", group: "transition-metal", row: 7, col: 11, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 112, symbol: "Cn", name: "Copernicium", group: "transition-metal", row: 7, col: 12, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 113, symbol: "Nh", name: "Nihonium", group: "post-transition-metal", row: 7, col: 13, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 114, symbol: "Fl", name: "Flerovium", group: "post-transition-metal", row: 7, col: 14, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 115, symbol: "Mc", name: "Moscovium", group: "post-transition-metal", row: 7, col: 15, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 116, symbol: "Lv", name: "Livermorium", group: "post-transition-metal", row: 7, col: 16, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 117, symbol: "Ts", name: "Tennessine", group: "halogen", row: 7, col: 17, melting_point_celsius: null, boiling_point_celsius: null },
            { number: 118, symbol: "Og", name: "Oganesson", group: "noble-gas", row: 7, col: 18, melting_point_celsius: null, boiling_point_celsius: null },
            // Lanthanides (separate block, rendered at row 9, cols 4-18 for visual layout)
            { number: 57, symbol: "La", name: "Lanthanum", group: "lanthanide", row: 9, col: 4, melting_point_celsius: 920, boiling_point_celsius: 3464 },
            { number: 58, symbol: "Ce", name: "Cerium", group: "lanthanide", row: 9, col: 5, melting_point_celsius: 795, boiling_point_celsius: 3443 },
            { number: 59, symbol: "Pr", name: "Praseodymium", group: "lanthanide", row: 9, col: 6, melting_point_celsius: 935, boiling_point_celsius: 3522 },
            { number: 60, symbol: "Nd", name: "Neodymium", group: "lanthanide", row: 9, col: 7, melting_point_celsius: 1021, boiling_point_celsius: 3074 },
            { number: 61, symbol: "Pm", name: "Promethium", group: "lanthanide", row: 9, col: 8, melting_point_celsius: 1042, boiling_point_celsius: 3000 },
            { number: 62, symbol: "Sm", name: "Samarium", group: "lanthanide", row: 9, col: 9, melting_point_celsius: 1072, boiling_point_celsius: 1794 },
            { number: 63, symbol: "Eu", name: "Europium", group: "lanthanide", row: 9, col: 10, melting_point_celsius: 822, boiling_point_celsius: 1529 },
            { number: 64, symbol: "Gd", name: "Gadolinium", group: "lanthanide", row: 9, col: 11, melting_point_celsius: 1312, boiling_point_celsius: 3273 },
            { number: 65, symbol: "Tb", name: "Terbium", group: "lanthanide", row: 9, col: 12, melting_point_celsius: 1356, boiling_point_celsius: 3230 },
            { number: 66, symbol: "Dy", name: "Dysprosium", group: "lanthanide", row: 9, col: 13, melting_point_celsius: 1412, boiling_point_celsius: 2567 },
            { number: 67, symbol: "Ho", name: "Holmium", group: "lanthanide", row: 9, col: 14, melting_point_celsius: 1474, boiling_point_celsius: 2700 },
            { number: 68, symbol: "Er", name: "Erbium", group: "lanthanide", row: 9, col: 15, melting_point_celsius: 1529, boiling_point_celsius: 2868 },
            { number: 69, symbol: "Tm", name: "Thulium", group: "lanthanide", row: 9, col: 16, melting_point_celsius: 1545, boiling_point_celsius: 1950 },
            { number: 70, symbol: "Yb", name: "Ytterbium", group: "lanthanide", row: 9, col: 17, melting_point_celsius: 819, boiling_point_celsius: 1196 },
            { number: 71, symbol: "Lu", name: "Lutetium", group: "lanthanide", row: 9, col: 18, melting_point_celsius: 1663, boiling_point_celsius: 3402 },
            // Actinides (separate block, rendered at row 10, cols 4-18 for visual layout)
            { number: 89, symbol: "Ac", name: "Actinium", group: "actinide", row: 10, col: 4, melting_point_celsius: 1050, boiling_point_celsius: 3200 },
            { number: 90, symbol: "Th", name: "Thorium", group: "actinide", row: 10, col: 5, melting_point_celsius: 1750, boiling_point_celsius: 4788 },
            { number: 91, symbol: "Pa", name: "Protactinium", group: "actinide", row: 10, col: 6, melting_point_celsius: 1572, boiling_point_celsius: 4027 },
            { number: 92, symbol: "U", name: "Uranium", group: "actinide", row: 10, col: 7, melting_point_celsius: 1132, boiling_point_celsius: 4131 },
            { number: 93, symbol: "Np", name: "Neptunium", group: "actinide", row: 10, col: 8, melting_point_celsius: 639, boiling_point_celsius: 4000 },
            { number: 94, symbol: "Pu", name: "Plutonium", group: "actinide", row: 10, col: 9, melting_point_celsius: 640, boiling_point_celsius: 3228 },
            { number: 95, symbol: "Am", name: "Americium", group: "actinide", row: 10, col: 10, melting_point_celsius: 1176, boiling_point_celsius: 2607 },
            { number: 96, symbol: "Cm", name: "Curium", group: "actinide", row: 10, col: 11, melting_point_celsius: 1340, boiling_point_celsius: 3100 },
            { number: 97, symbol: "Bk", name: "Berkelium", group: "actinide", row: 10, col: 12, melting_point_celsius: 986, boiling_point_celsius: 2627 },
            { number: 98, symbol: "Cf", name: "Californium", group: "actinide", row: 10, col: 13, melting_point_celsius: 900, boiling_point_celsius: 1743 },
            { number: 99, symbol: "Es", name: "Einsteinium", group: "actinide", row: 10, col: 14, melting_point_celsius: 860, boiling_point_celsius: 991 },
            { number: 100, symbol: "Fm", name: "Fermium", group: "actinide", row: 10, col: 15, melting_point_celsius: 1527, boiling_point_celsius: null },
            { number: 101, symbol: "Md", name: "Mendelevium", group: "actinide", row: 10, col: 16, melting_point_celsius: 827, boiling_point_celsius: null },
            { number: 102, symbol: "No", name: "Nobelium", group: "actinide", row: 10, col: 17, melting_point_celsius: 827, boiling_point_celsius: null },
            { number: 103, symbol: "Lr", name: "Lawrencium", group: "actinide", row: 10, col: 18, melting_point_celsius: 1627, boiling_point_celsius: null }
        ];

        // Hàm xác định trạng thái vật lý của nguyên tố
        function getPhysicalState(temperatureC, meltingPointC, boilingPointC) {
            if (meltingPointC === null || boilingPointC === null || isNaN(meltingPointC) || isNaN(boilingPointC)) {
                return 'UnknownState';
            }
            if (temperatureC < meltingPointC) {
                return 'Solid';
            } else if (temperatureC >= meltingPointC && temperatureC < boilingPointC) {
                return 'Liquid';
            } else {
                return 'Gas';
            }
        }

        // Hàm cập nhật màu sắc các ô nguyên tố dựa trên nhiệt độ và áp dụng bộ lọc hiện tại
        function updateElementStates() {
            elements.forEach(element => {
                const cell = document.querySelector(`[data-symbol="${element.symbol}"]`);
                if (cell && !element.isPlaceholder) {
                    // Xóa tất cả các lớp trạng thái cũ
                    cell.classList.remove('Solid', 'Liquid', 'Gas', 'UnknownState');

                    // Thêm lớp trạng thái mới dựa trên nhiệt độ
                    const state = getPhysicalState(currentTemperatureCelsius, element.melting_point_celsius, element.boiling_point_celsius);
                    cell.classList.add(state);
                }
            });
            // Sau khi cập nhật trạng thái, áp dụng lại bộ lọc hiện có
            applyCurrentFilter();
        }

        // Hàm chuyển đổi nhiệt độ
        function convertTemperature(value, fromUnit, toUnit) {
            if (isNaN(value)) return NaN;
            let kelvin;
            if (fromUnit === 'C') {
                kelvin = value + 273.15;
            } else if (fromUnit === 'F') {
                kelvin = (value - 32) * 5/9 + 273.15;
            } else if (fromUnit === 'K') {
                kelvin = value;
            }

            if (toUnit === 'C') {
                return kelvin - 273.15;
            } else if (toUnit === 'F') {
                return (kelvin - 273.15) * 9/5 + 32;
            } else if (toUnit === 'K') {
                return kelvin;
            }
            return NaN;
        }

        // Cập nhật tất cả các ô nhập nhiệt độ khi một ô thay đổi
        function updateTemperatureInputs(sourceInputId) {
            let value = parseFloat(document.getElementById(sourceInputId).value);
            let unit = sourceInputId.replace('Input', '').replace('celsius', 'C').replace('fahrenheit', 'F').replace('kelvin', 'K');

            if (isNaN(value)) {
                // Nếu giá trị không hợp lệ, không cập nhật gì
                return;
            }
            
            // Cập nhật nhiệt độ Celsius hiện tại của ứng dụng
            currentTemperatureCelsius = convertTemperature(value, unit, 'C');

            // Cập nhật các ô input khác
            if (sourceInputId !== 'celsiusInput') {
                celsiusInput.value = currentTemperatureCelsius.toFixed(2);
            }
            if (sourceInputId !== 'fahrenheitInput') {
                fahrenheitInput.value = convertTemperature(value, unit, 'F').toFixed(2);
            }
            if (sourceInputId !== 'kelvinInput') {
                kelvinInput.value = convertTemperature(value, unit, 'K').toFixed(2);
            }

            // Cập nhật thanh trượt range
            temperatureRange.value = currentTemperatureCelsius;

            // Cập nhật trạng thái các nguyên tố
            updateElementStates();
        }

        // Hàm áp dụng bộ lọc vào các ô nguyên tố
        function applyFilter(filterType, filterValue, clickedLegendItem) {
            const allElementCells = document.querySelectorAll('.element-cell');
            const allLegendItems = document.querySelectorAll('.legend-item');

            // Xóa highlight của tất cả các mục chú giải
            allLegendItems.forEach(item => item.classList.remove('selected-filter-item'));

            // Nếu bộ lọc này đã được chọn, hãy hủy chọn nó
            if (activeFilter.type === filterType && activeFilter.value === filterValue) {
                activeFilter = { type: null, value: null, element: null };
            } else {
                activeFilter = { type: filterType, value: filterValue, element: clickedLegendItem };
                // Highlight mục chú giải được chọn
                if (clickedLegendItem) {
                    clickedLegendItem.classList.add('selected-filter-item');
                }
            }
            
            applyCurrentFilter(); // Áp dụng bộ lọc mới (hoặc hủy)
        }

        // Hàm áp dụng bộ lọc hiện tại (dựa trên biến activeFilter)
        function applyCurrentFilter() {
            const allElementCells = document.querySelectorAll('.element-cell');

            allElementCells.forEach(cell => {
                // Đảm bảo không làm mờ các ô placeholder
                if (cell.classList.contains('lanthanide-placeholder') || cell.classList.contains('actinide-placeholder')) {
                    cell.classList.remove('dimmed');
                    cell.style.pointerEvents = 'auto';
                    return;
                }

                if (activeFilter.type === null) {
                    // Không có bộ lọc nào hoạt động, hiển thị tất cả
                    cell.classList.remove('dimmed');
                    cell.style.pointerEvents = 'auto'; // Kích hoạt lại tương tác
                } else {
                    let matches = false;
                    if (activeFilter.type === 'state') {
                        // Kiểm tra xem ô có lớp trạng thái phù hợp với bộ lọc không
                        matches = cell.classList.contains(activeFilter.value);
                    } else if (activeFilter.type === 'group') {
                        // Kiểm tra xem ô có lớp nhóm phù hợp với bộ lọc không
                        matches = cell.classList.contains(activeFilter.value);
                    }

                    if (matches) {
                        cell.classList.remove('dimmed');
                        cell.style.pointerEvents = 'auto'; // Kích hoạt lại tương tác
                    } else {
                        cell.classList.add('dimmed');
                        cell.style.pointerEvents = 'none'; // Vô hiệu hóa tương tác
                    }
                }
            });
        }

        // Hàm reset bảng về trạng thái ban đầu
        function resetTable() {
            // Đặt lại nhiệt độ về mặc định
            celsiusInput.value = 25;
            updateTemperatureInputs('celsiusInput'); // Kích hoạt cập nhật
            
            // Xóa bộ lọc đang hoạt động
            activeFilter = { type: null, value: null, element: null };
            document.querySelectorAll('.selected-filter-item').forEach(item => item.classList.remove('selected-filter-item'));
            applyCurrentFilter(); // Áp dụng để xóa hiệu ứng làm mờ
            
            // Xóa trạng thái active của ô nguyên tố
            document.querySelectorAll('.element-cell.active').forEach(cell => {
                cell.classList.remove('active');
            });

            hideBottomSheet(); // Đóng bottom sheet nếu đang mở

            updateStatus('success-text', "Bảng đã được reset về trạng thái chuẩn.");
        }

        // Gắn sự kiện cho thanh trượt và các ô input nhiệt độ
        temperatureRange.addEventListener('input', () => {
            currentTemperatureCelsius = parseFloat(temperatureRange.value);
            celsiusInput.value = currentTemperatureCelsius.toFixed(2);
            fahrenheitInput.value = convertTemperature(currentTemperatureCelsius, 'C', 'F').toFixed(2);
            kelvinInput.value = convertTemperature(currentTemperatureCelsius, 'C', 'K').toFixed(2);
            updateElementStates(); // Cập nhật trạng thái và áp dụng lại bộ lọc
        });

        celsiusInput.addEventListener('change', () => updateTemperatureInputs('celsiusInput'));
        fahrenheitInput.addEventListener('change', () => updateTemperatureInputs('fahrenheitInput'));
        kelvinInput.addEventListener('change', () => updateTemperatureInputs('kelvinInput'));

        // Gắn sự kiện cho nút Reset
        resetButton.addEventListener('click', resetTable);

        // Tạo bảng tuần hoàn trên giao diện
        function createPeriodicTable() {
            periodicTable.innerHTML = '';
            lanthanidesBlock.innerHTML = '';
            actinidesBlock.innerHTML = '';

            const mainGrid = Array(7).fill(null).map(() => Array(18).fill(null));
            const lanthanidesSubGrid = Array(1).fill(null).map(() => Array(18).fill(null));
            const actinidesSubGrid = Array(1).fill(null).map(() => Array(18).fill(null));

            elements.forEach(element => {
                const cell = document.createElement('div');
                cell.classList.add('element-cell', element.group);
                cell.dataset.symbol = element.symbol;
                cell.dataset.name = element.name;
                cell.dataset.number = element.number;

                if (element.isPlaceholder) {
                    cell.innerHTML = `
                        <div class="text-center font-bold text-gray-700 text-sm">${element.symbol}</div>
                        <div class="text-xs mt-1 text-gray-600">${element.name}</div>
                    `;
                    mainGrid[element.row - 1][element.col - 1] = cell;
                }
                else if (element.group === 'lanthanide') {
                    cell.innerHTML = `
                        <div class="element-number">${element.number}</div>
                        <div class="element-symbol">${element.symbol}</div>
                        <div class="element-name">${element.name}</div>
                    `;
                    lanthanidesSubGrid[0][element.col - 1] = cell;
                    cell.addEventListener('click', () => handleElementClick(element));
                }
                else if (element.group === 'actinide') {
                    cell.innerHTML = `
                        <div class="element-number">${element.number}</div>
                        <div class="element-symbol">${element.symbol}</div>
                        <div class="element-name">${element.name}</div>
                    `;
                    actinidesSubGrid[0][element.col - 1] = cell;
                    cell.addEventListener('click', () => handleElementClick(element));
                }
                else {
                    cell.innerHTML = `
                        <div class="element-number">${element.number}</div>
                        <div class="element-symbol">${element.symbol}</div>
                        <div class="element-name">${element.name}</div>
                    `;
                    mainGrid[element.row - 1][element.col - 1] = cell;
                    cell.addEventListener('click', () => handleElementClick(element));
                }
            });

            // --- CHÈN CHÚ GIẢI VÀO LƯỚI CHÍNH ---
            // Chú giải Trạng thái vật lý
            const physicalStateLegendSection = document.createElement('div');
            physicalStateLegendSection.className = 'legend-section physical-state-legend-section';
            physicalStateLegendSection.style.gridColumn = '4 / span 4'; // Cột 4 đến 7
            physicalStateLegendSection.style.gridRow = '2'; // Hàng 2
            physicalStateLegendSection.innerHTML = `
                <h3>Trạng thái vật lý</h3>
                <div class="legend-items">
                    <div class="legend-item Solid" data-filter-type="state" data-filter-value="Solid">Rắn</div>
                    <div class="legend-item Liquid" data-filter-type="state" data-filter-value="Liquid">Lỏng</div>
                    <div class="legend-item Gas" data-filter-type="state" data-filter-value="Gas">Khí</div>
                    <div class="legend-item UnknownState" data-filter-type="state" data-filter-value="UnknownState">Chưa biết</div>
                </div>
            `;
            // Gắn sự kiện cho các mục chú giải vật lý
            physicalStateLegendSection.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    applyFilter(item.dataset.filterType, item.dataset.filterValue, item);
                });
            });
            mainGrid[1][3] = physicalStateLegendSection; // Đặt vào vị trí (row=2, col=4) - index 1,3

            // Chú giải Loại nguyên tố
            const elementTypeLegendSection = document.createElement('div');
            elementTypeLegendSection.className = 'legend-section element-type-legend-section';
            elementTypeLegendSection.style.gridColumn = '8 / span 5'; // Cột 8 đến 12
            elementTypeLegendSection.style.gridRow = '2 / span 2'; // Hàng 2 và 3
            elementTypeLegendSection.innerHTML = `
                <h3>Loại nguyên tố</h3>
                <div class="legend-items">
                    <div class="legend-item alkali-metal" data-filter-type="group" data-filter-value="alkali-metal">Kim loại kiềm</div>
                    <div class="legend-item alkaline-earth-metal" data-filter-type="group" data-filter-value="alkaline-earth-metal">Kim loại kiềm thổ</div>
                    <div class="legend-item transition-metal" data-filter-type="group" data-filter-value="transition-metal">Kim loại chuyển tiếp</div>
                    <div class="legend-item post-transition-metal" data-filter-type="group" data-filter-value="post-transition-metal">Kim loại sau chuyển tiếp</div>
                    <div class="legend-item metalloid" data-filter-type="group" data-filter-value="metalloid">Á kim</div>
                    <div class="legend-item other-nonmetal" data-filter-type="group" data-filter-value="other-nonmetal">Phi kim khác</div>
                    <div class="legend-item halogen" data-filter-type="group" data-filter-value="halogen">Halogen</div>
                    <div class="legend-item noble-gas" data-filter-type="group" data-filter-value="noble-gas">Khí hiếm</div>
                    <div class="legend-item lanthanide" data-filter-type="group" data-filter-value="lanthanide">Họ Lanthan</div>
                    <div class="legend-item actinide" data-filter-type="group" data-filter-value="actinide">Họ Actini</div>
                </div>
            `;
            // Gắn sự kiện cho các mục chú giải loại nguyên tố
            elementTypeLegendSection.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    applyFilter(item.dataset.filterType, item.dataset.filterValue, item);
                });
            });
            mainGrid[1][7] = elementTypeLegendSection; // Đặt vào vị trí (row=2, col=8) - index 1,7

            // Duyệt qua mainGrid và thêm các ô vào periodicTable
            for (let r = 0; r < mainGrid.length; r++) {
                for (let c = 0; c < mainGrid[r].length; c++) {
                    if (mainGrid[r][c]) {
                        periodicTable.appendChild(mainGrid[r][c]);
                    } else {
                        // Chỉ thêm ô trống nếu không phải là một trong các ô mà legend chiếm
                        // Điều này để tránh tạo các ô trống không cần thiết dưới legend
                        const emptyCell = document.createElement('div');
                        emptyCell.classList.add('empty-cell');
                        periodicTable.appendChild(emptyCell);
                    }
                }
            }

            // Render khối Lanthanide (như trước)
            for(let i = 0; i < 3; i++) {
                const empty = document.createElement('div');
                empty.classList.add('empty-cell');
                lanthanidesBlock.appendChild(empty);
            }
            for (let c = 3; c < lanthanidesSubGrid[0].length; c++) {
                if (lanthanidesSubGrid[0][c]) {
                    lanthanidesBlock.appendChild(lanthanidesSubGrid[0][c]);
                } else {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('empty-cell');
                    lanthanidesBlock.appendChild(emptyCell);
                }
            }

            // Render khối Actinide (như trước)
            for(let i = 0; i < 3; i++) {
                const empty = document.createElement('div');
                empty.classList.add('empty-cell');
                actinidesBlock.appendChild(empty);
            }
            for (let c = 3; c < actinidesSubGrid[0].length; c++) {
                if (actinidesSubGrid[0][c]) {
                    actinidesBlock.appendChild(actinidesSubGrid[0][c]);
                } else {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('empty-cell');
                    actinidesBlock.appendChild(emptyCell);
                }
            }
            updateElementStates(); // Cập nhật trạng thái ban đầu sau khi tạo bảng
        }

        // Xử lý khi nhấp vào một nguyên tố
        async function handleElementClick(element) {
            if (element.isPlaceholder) {
                return;
            }

            // Hủy bỏ mọi bộ lọc đang hoạt động khi một nguyên tố được nhấp
            activeFilter = { type: null, value: null, element: null };
            document.querySelectorAll('.selected-filter-item').forEach(item => item.classList.remove('selected-filter-item'));
            applyCurrentFilter(); // Loại bỏ hiệu ứng làm mờ

            document.querySelectorAll('.element-cell').forEach(cell => {
                cell.classList.remove('active');
            });

            const clickedCell = document.querySelector(`[data-symbol="${element.symbol}"]`);
            if (clickedCell) {
                clickedCell.classList.add('active');
            }

            showBottomSheet();
            detailElementName.textContent = `${element.name} (${element.symbol}) - ${element.number}`;
            geminiDetailContent.innerHTML = `<p><strong>Số nguyên tử:</strong> ${element.number}</p>
                                        <p><strong>Ký hiệu:</strong> ${element.symbol}</p>
                                        <p><strong>Tên:</strong> ${element.name}</p>
                                        <p class="text-gray-500">Đang yêu cầu Gemini AI để có thêm thông tin...</p>`;
            geminiLoading.classList.remove('hidden');

            if (!model) {
                geminiDetailContent.innerHTML = `<p class="error">Lỗi: Mô hình AI chưa được khởi tạo. Vui lòng kiểm tra console.</p>`;
                geminiLoading.classList.add('hidden');
                updateStatus('error-text', "Mô hình AI chưa sẵn sàng.");
                return;
            }

            try {
                const promptText = `Cung cấp thông tin chi tiết về nguyên tố hóa học ${element.name} (ký hiệu ${element.symbol}, số nguyên tử ${element.number}). Vui lòng bao gồm:
- Tên đầy đủ (full name)
- Ký hiệu nguyên tử (atomic symbol)
- Số nguyên tử (atomic number)
- Khối lượng nguyên tử (atomic mass)
- Cấu hình electron (electron configuration)
- Độ âm điện (electronegativity)
- Trạng thái ở điều kiện tiêu chuẩn (standard state)
- Điểm nóng chảy (melting point)
- Điểm sôi (boiling point)
- Lịch sử phát hiện (discovery history)
- Ứng dụng phổ biến (common uses)
Vui lòng trả lời dưới dạng văn bản có cấu trúc với các mục rõ ràng sử dụng định dạng Markdown (ví dụ: ## Tiêu đề, - Danh sách, **in đậm**, *in nghiêng*, \`code\`, liên kết). Sử dụng ngôn ngữ tiếng Việt.`;

                updateStatus('info-text', `Đang hỏi Gemini về ${element.name}...`);
                const result = await model.generateContent(promptText);
                const response = result.response;
                const text = response.text();

                geminiDetailContent.innerHTML = `
                    <p><strong>Tên đầy đủ:</strong> ${element.name}</p>
                    <p><strong>Ký hiệu:</strong> ${element.symbol}</p>
                    <p><strong>Số nguyên tử:</strong> ${element.number}</p>
                    <hr class="my-4 border-t border-blue-200">
                    <h4 class="font-bold text-md mb-2 text-blue-600">Thông tin chi tiết từ Gemini AI:</h4>
                    <div class="text-gray-700">${marked.parse(text)}</div>
                `;
                updateStatus('success-text', `Đã nhận thông tin về ${element.name} từ Gemini.`);

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                geminiDetailContent.innerHTML = `<p class="error">Lỗi khi lấy thông tin từ Gemini AI: ${error.message}.<br>Vui lòng kiểm tra Console (F12) để biết thêm chi tiết.</p>`;
                updateStatus('error-text', `Lỗi Gemini API: ${error.message}.`);
            } finally {
                geminiLoading.classList.add('hidden');
            }
        }

        // Khởi tạo ứng dụng khi DOM đã tải xong
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            createPeriodicTable();
            // Cập nhật trạng thái nhiệt độ ban đầu khi tải trang
            updateTemperatureInputs('celsiusInput');
        });
    </script>
</body>
</html>

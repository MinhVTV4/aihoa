<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine H√≥a h·ªçc AI v3.0 - Nh√† H√≥a h·ªçc AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --dark-bg: #111827; --light-bg: #1f2937; --panel-bg: #374151; --accent-color: #8b5cf6; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #e5e7eb;
        }
        .simulation-container {
            width: 95vw;
            max-width: 1000px;
            background: var(--light-bg);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
        }
        #reaction-chamber {
            position: relative;
            width: 100%;
            height: 500px;
            background: var(--dark-bg);
            border-radius: 1rem;
            overflow: hidden;
            cursor: grab;
        }
        #reaction-chamber canvas { display: block; }
        .ui-panel {
            background: var(--panel-bg);
            border-radius: 1rem;
            padding: 1.25rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .input-group { display: flex; gap: 1rem; align-items: center; }
        #equation-input {
            flex-grow: 1;
            background: var(--light-bg);
            border: 1px solid var(--accent-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #fff;
        }
        .main-btn {
            background-image: linear-gradient(to right, #6366f1, var(--accent-color));
            color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            border: none; cursor: pointer; transition: all 0.3s;
            font-weight: 600;
        }
        .main-btn:hover { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
        .main-btn:disabled { background-image: none; background-color: #4b5563; cursor: not-allowed; }
        
        #controls-bar { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;}
        .icon-btn {
            background: transparent; border: 1px solid #6b7280;
            color: #d1d5db; width: 40px; height: 40px;
            border-radius: 50%; display: flex;
            justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s; font-size: 1.2rem;
        }
        .icon-btn:hover { border-color: var(--accent-color); color: white; }
        .icon-btn:disabled { color: #6b7280; border-color: #4b5563; cursor: not-allowed;}

        #progress-container { flex-grow: 1; height: 8px; background: #4b5563; border-radius: 99px; overflow: hidden;}
        #progress-bar { width: 0%; height: 100%; background: var(--accent-color); border-radius: 99px; }
        #info-text { text-align: center; min-height: 24px; }
        .loading-spinner { /* ... spinner styles ... */ }
    </style>
</head>
<body>
    <div class="simulation-container">
        <h1 class="text-2xl font-bold text-center mb-4">Nh√† H√≥a h·ªçc AI v3.0</h1>
        <div id="reaction-chamber"></div>
        <div class="ui-panel">
            <div class="input-group">
                <!-- Thay ƒë·ªïi ·ªü ƒë√¢y: C·∫≠p nh·∫≠t gi√° tr·ªã v√† placeholder -->
                <input id="equation-input" type="text" value="Hydro v√† Oxy" placeholder="Nh·∫≠p c√°c ch·∫•t tham gia (vd: S·∫Øt v√† Oxi)...">
                <button id="generate-btn" class="main-btn">T·∫°o Ph·∫£n ·ª©ng</button>
            </div>
             <div id="controls-bar">
                <button id="play-pause-btn" class="icon-btn" disabled>‚ñ∂Ô∏è</button>
                <button id="restart-btn" class="icon-btn" disabled>üîÑ</button>
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>
            </div>
            <p id="info-text">H√£y xem AI d·ª± ƒëo√°n v√† di·ªÖn h·ªça ph·∫£n ·ª©ng h√≥a h·ªçc!</p>
        </div>
    </div>

    <!-- Imports -->
    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
        
        // --- Firebase, AI, 3D Engine Setup (gi·ªØ nguy√™n) ---
        const firebaseConfig = { apiKey: "AIzaSyBVpguEIjTnIVOk1Ld0u-BGC7nM-pSww_o", authDomain: "aihoa-ac63b.firebaseapp.com", projectId: "aihoa-ac63b", storageBucket: "aihoa-ac63b.firebasestorage.app", messagingSenderId: "241068548961", appId: "1:241068548961:web:33d4126d020e9372d15b20"};
        let model; try { const app = initializeApp(firebaseConfig); const ai = getAI(app, { backend: new GoogleAIBackend() }); model = getGenerativeModel(ai, { model: "gemini-2.5-flash" }); } catch (e) { console.error("L·ªói kh·ªüi t·∫°o Firebase/AI:", e); }
        const chamber = document.getElementById('reaction-chamber');
        let renderer, scene, camera, controls, composer, mainTimeline;
        let molecules = [];

        function init3D() { 
             try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, chamber.clientWidth / chamber.clientHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(chamber.clientWidth, chamber.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                chamber.appendChild(renderer.domElement);
                const renderPass = new RenderPass(scene, camera);
                const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                bloomPass.threshold = 0; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
                const outputPass = new OutputPass();
                composer = new EffectComposer(renderer);
                composer.addPass(renderPass); composer.addPass(bloomPass); composer.addPass(outputPass);
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0); directionalLight.position.set(5, 10, 7.5); scene.add(directionalLight);
                camera.position.z = 15;
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                function animate() { requestAnimationFrame(animate); controls.update(); composer.render(); }
                animate();
            } catch (error) { chamber.innerHTML = `<div class="p-4 text-center text-red-300"><h2>L·ªói WebGL</h2><p>Kh√¥ng th·ªÉ t·∫°o m√¥i tr∆∞·ªùng 3D.</p></div>`; throw new Error("WebGL init failed"); }
        }
        window.addEventListener('resize', () => { /* ... resize logic ... */ });

        // --- Core Application Logic ---
        const generateBtn = document.getElementById('generate-btn');
        const input = document.getElementById('equation-input');
        const infoText = document.getElementById('info-text');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressBar = document.getElementById('progress-bar');

        function clearScene() { 
             molecules.forEach(m => {
                m.children.forEach(c => {
                    c.geometry.dispose();
                    c.material.dispose();
                });
                scene.remove(m);
            });
            molecules = [];
        }

        function drawMolecule3D(moleculeDef, x, y, z) {
            const group = new THREE.Group();
            const atomRadius = 0.5;
            moleculeDef.atoms.forEach((atomDef, i) => {
                const geometry = new THREE.SphereGeometry(atomRadius, 32, 32);
                const material = new THREE.MeshStandardMaterial({ color: atomDef.color, metalness: 0.4, roughness: 0.4, emissive: '#000000' });
                const atomMesh = new THREE.Mesh(geometry, material);
                if (moleculeDef.atoms.length > 1) { const angle = (i / moleculeDef.atoms.length) * 2 * Math.PI; atomMesh.position.x = Math.cos(angle) * atomRadius; atomMesh.position.y = Math.sin(angle) * atomRadius; }
                group.add(atomMesh);
            });
            group.position.set(x, y, z);
            scene.add(group);
            molecules.push(group);
            return group;
        }
        
        // --- Animation Engine ---
        function runAnimation(plan) {
            if (mainTimeline) mainTimeline.kill(); 
            clearScene();
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ ph·∫£n ·ª©ng tr√™n UI
            infoText.innerText = `ƒêang chu·∫©n b·ªã ho·∫°t ·∫£nh cho: ${plan.title}`;

            mainTimeline = gsap.timeline({
                 onUpdate: () => {
                    progressBar.style.width = `${mainTimeline.progress() * 100}%`;
                    playPauseBtn.textContent = mainTimeline.paused() ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
                 },
                 onComplete: () => {
                    infoText.innerText = "Ho·∫°t ·∫£nh ho√†n t·∫•t!";
                    playPauseBtn.textContent = "‚ñ∂Ô∏è";
                    playPauseBtn.disabled = true;
                 }
            });
            
            playPauseBtn.disabled = false;
            restartBtn.disabled = false;
            playPauseBtn.textContent = "‚è∏Ô∏è";

            const reactantObjects = [];
            let reactantX = -10;
            plan.reactants.forEach((r) => {
                for (let j = 0; j < r.count; j++) {
                    const moleculeObj = drawMolecule3D(r, reactantX, (j % 2 === 0 ? 1 : -1) * 4, 0);
                    reactantObjects.push({obj: moleculeObj});
                    reactantX += 5;
                }
            });
            
             plan.animationSteps.forEach(step => {
                // T·∫°o m·ªôt label v√† m·ªôt callback ƒë·ªÉ c·∫≠p nh·∫≠t text t·∫°i c√πng m·ªôt th·ªùi ƒëi·ªÉm
                mainTimeline.add(() => { infoText.innerText = step.text || '...'; }, step.type);

                if (step.type === 'move_to_center') { 
                    mainTimeline.to(camera.position, { z: 25, duration: 2.5, ease: "power2.inOut"}, step.type);
                    reactantObjects.forEach((m, i) => { 
                        mainTimeline.to(m.obj.position, { x: (i % 3 - 1) * 3, y: Math.floor(i / 3) * 3 - 1, z: 0, duration: 2.5, ease: "power2.inOut" }, step.type); 
                    });
                } else if (step.type === 'break_bonds') { 
                    mainTimeline.to(camera.position, { z: 12, duration: 2, ease: "power2.inOut"}, step.type); 
                    reactantObjects.forEach(m => { 
                        m.obj.children.forEach((atomMesh, i) => { 
                            mainTimeline.to(atomMesh.material.emissive, { r: 1, g: 1, b: 0.8, duration: 1, ease: "power2.in" }, step.type); 
                            const angle = (i / m.obj.children.length) * 2 * Math.PI; 
                            mainTimeline.to(atomMesh.position, { x: atomMesh.position.x + Math.cos(angle) * 0.8, y: atomMesh.position.y + Math.sin(angle) * 0.8, duration: 2, ease: "back.out(4)" }, step.type); 
                        }); 
                    }); 
                } else if (step.type === 'rearrange') { 
                    reactantObjects.forEach(m => { 
                        mainTimeline.to(m.obj.children.map(c => c.material), { opacity: 0, duration: 1, onComplete: () => scene.remove(m.obj) }, step.type); 
                    }); 
                    if (plan.isExothermic) { 
                        mainTimeline.add(() => { 
                            const shockwaveGeo = new THREE.TorusGeometry(1, 0.1, 16, 100); 
                            const shockwaveMat = new THREE.MeshBasicMaterial({ color: 0xffffee, transparent: true, opacity: 1 }); 
                            const shockwave = new THREE.Mesh(shockwaveGeo, shockwaveMat); 
                            shockwave.rotation.x = Math.PI / 2; 
                            scene.add(shockwave); 
                            gsap.to(shockwave.scale, { x: 20, y: 20, z: 20, duration: 2, ease: "power1.out" }); 
                            gsap.to(shockwave.material, { opacity: 0, duration: 2, ease: "power1.out", onComplete: () => scene.remove(shockwave) }); 
                        }, step.type + "+=0.5"); 
                    } 
                    let productX = -5; 
                    plan.products.forEach(p => { 
                        for (let j = 0; j < p.count; j++) { 
                            const productObj = drawMolecule3D(p, productX, (j % 2 === 0 ? 1 : -1) * 3, 0); 
                            productObj.children.forEach(c => { c.material.transparent = true; c.material.opacity = 0; }); 
                            mainTimeline.to(productObj.children.map(c => c.material), { opacity: 1, duration: 2 }, step.type + "+=1"); 
                            mainTimeline.to(productObj.children.map(c => c.material.emissive), { r: 0, g: 0, b: 0, duration: 2 }, step.type + "+=1"); 
                            productX += 5; 
                        } 
                    }); 
                }
            });
        }

        async function generateReactionPlan() {
            if (!model || !renderer) { 
                infoText.innerText = "L·ªói: Engine AI ch∆∞a s·∫µn s√†ng.";
                return; 
            }
            const userInput = input.value;
            if (!userInput) { 
                infoText.innerText = "Vui l√≤ng nh·∫≠p c√°c ch·∫•t tham gia.";
                return; 
            }

            infoText.innerHTML = 'AI ƒëang t∆∞ duy... üß†';
            generateBtn.disabled = true;

            // --- THAY ƒê·ªîI L·ªöN ·ªû ƒê√ÇY: PROMPT M·ªöI ---
            // Y√™u c·∫ßu AI th·ª±c hi·ªán nhi·ªÅu vi·ªác h∆°n: d·ª± ƒëo√°n, c√¢n b·∫±ng, r·ªìi m·ªõi t·∫°o k·ªãch b·∫£n
            const prompt = `
            T·ª´ c√°c ch·∫•t tham gia do ng∆∞·ªùi d√πng cung c·∫•p l√†: "${userInput}".
            H√£y th·ª±c hi·ªán c√°c b∆∞·ªõc sau m·ªôt c√°ch tu·∫ßn t·ª±:
            1. D·ª± ƒëo√°n s·∫£n ph·∫©m h√≥a h·ªçc c√≥ kh·∫£ nƒÉng x·∫£y ra nh·∫•t trong ƒëi·ªÅu ki·ªán ti√™u chu·∫©n.
            2. Vi·∫øt ph∆∞∆°ng tr√¨nh h√≥a h·ªçc ƒë·∫ßy ƒë·ªß v√† ƒë√£ ƒë∆∞·ª£c c√¢n b·∫±ng cho ph·∫£n ·ª©ng ƒë√≥.
            3. D·ª±a tr√™n ph∆∞∆°ng tr√¨nh b·∫°n v·ª´a t·∫°o, h√£y t·∫°o m·ªôt k·ªãch b·∫£n ho·∫°t ·∫£nh chi ti·∫øt d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.

            ƒê·ªëi t∆∞·ª£ng JSON ph·∫£i c√≥ c·∫•u tr√∫c ch√≠nh x√°c nh∆∞ sau:
            - "title": (string) Ph∆∞∆°ng tr√¨nh h√≥a h·ªçc ƒë·∫ßy ƒë·ªß m√† b·∫°n ƒë√£ t·∫°o (v√≠ d·ª•: "2H2 + O2 -> 2H2O").
            - "isExothermic": (boolean) Ph·∫£n ·ª©ng c√≥ t·ªèa nhi·ªát hay kh√¥ng.
            - "reactants": (array) M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng ch·∫•t ph·∫£n ·ª©ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ d·∫°ng {molecule: string, count: number, atoms: [{symbol: string, color: string}]}.
            - "products": (array) M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng s·∫£n ph·∫©m, c·∫•u tr√∫c t∆∞∆°ng t·ª± reactants.
            - "animationSteps": (array) M·ªôt m·∫£ng c√°c b∆∞·ªõc ho·∫°t ·∫£nh, m·ªói b∆∞·ªõc c√≥ d·∫°ng {type: 'move_to_center' | 'break_bonds' | 'rearrange', text: string}.

            S·ª≠ d·ª•ng c√°c m√†u sau cho nguy√™n t·ª≠ (h√£y t·ª± suy ra c√°c m√†u kh√°c n·∫øu c·∫ßn):
            - H: #FFFFFF (Tr·∫Øng)
            - O: #FF6B6B (ƒê·ªè)
            - C: #333333 (X√°m ƒëen)
            - N: #6B9AFF (Xanh d∆∞∆°ng)
            - Fe: #A19D94 (X√°m kim lo·∫°i)
            - S: #FFF36B (V√†ng)
            - Cl: #6BFF8B (Xanh l√°)
            - Na: #B06BFF (T√≠m)

            Quan tr·ªçng: Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt kh·ªëi m√£ JSON h·ª£p l·ªá duy nh·∫•t, kh√¥ng ch·ª©a "'''json" hay b·∫•t k·ª≥ vƒÉn b·∫£n gi·∫£i th√≠ch n√†o kh√°c.
            `;
            
            try {
                const result = await model.generateContent(prompt);
                const textResponse = result.response.text();
                // D·ªçn d·∫πp vƒÉn b·∫£n ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ l√† JSON h·ª£p l·ªá
                const cleanedText = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                const plan = JSON.parse(cleanedText);
                runAnimation(plan);
            } catch (error) {
                console.error("L·ªói ph√¢n t√≠ch ho·∫∑c t·∫°o ho·∫°t ·∫£nh:", error);
                infoText.innerText = "ƒê√£ c√≥ l·ªói x·∫£y ra. AI c√≥ th·ªÉ ƒë√£ tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.";
            } finally {
                generateBtn.disabled = false;
            }
        }
        
        // --- Event Listeners cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn m·ªõi ---
        playPauseBtn.addEventListener('click', () => {
            if (mainTimeline) {
                mainTimeline.paused(!mainTimeline.paused());
            }
        });

        restartBtn.addEventListener('click', () => {
            if (mainTimeline) {
                mainTimeline.restart();
            }
        });
        
        init3D();
        generateBtn.addEventListener('click', generateReactionPlan);
    </script>
</body>
</html>
